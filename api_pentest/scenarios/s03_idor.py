import logging
import re
import time

from api_pentest.core.api_discovery import ArchitectureType
from api_pentest.core.models import ScenarioApplicability, Severity, TestStatus
from api_pentest.scenarios.base_scenario import BaseScenario

logger = logging.getLogger(__name__)


class S03IDOR(BaseScenario):
    """S03 - Insecure Direct Object Reference (IDOR) detection."""

    SCENARIO_ID = "S03"
    SCENARIO_NAME = "Insecure Direct Object Reference"
    OWASP_ID = "API1:2023"
    OWASP_NAME = "Broken Object Level Authorization"
    APPLICABILITY = ScenarioApplicability(
        architectures=[ArchitectureType.REST, ArchitectureType.HYBRID, ArchitectureType.UNKNOWN],
        classifications=["protected"],  # Only authenticated endpoints
    )

    # Pattern to find numeric IDs or UUIDs in URLs
    ID_PATTERNS = [
        (re.compile(r'/(\d{1,10})(?:/|$|\?)'), "numeric"),
        (re.compile(r'/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(?:/|$|\?)', re.I), "uuid"),
        (re.compile(r'[?&]id=(\d+)'), "query_numeric"),
        (re.compile(r'[?&]id=([0-9a-f-]{36})', re.I), "query_uuid"),
    ]

    def get_test_cases(self) -> list[str]:
        cases = ["id_enumeration"]
        if self.oauth and self.oauth_b:
            cases.append("cross_user_idor")
        cases.append("id_in_body")
        return cases

    def execute_test(self, test_name: str):
        if test_name == "id_enumeration":
            self._test_id_enumeration()
        elif test_name == "cross_user_idor":
            self._test_cross_user_idor()
        elif test_name == "id_in_body":
            self._test_id_in_body()

    def _find_ids_in_url(self, url: str) -> list[tuple[str, str, str]]:
        """Find IDs in a URL. Returns [(match_value, id_type, full_pattern_match)]."""
        found = []
        for pattern, id_type in self.ID_PATTERNS:
            for match in pattern.finditer(url):
                found.append((match.group(1), id_type, match.group(0)))
        return found

    def _modify_id(self, original: str, id_type: str) -> list[str]:
        """Generate modified IDs for testing."""
        modified = []

        if id_type in ("numeric", "query_numeric"):
            try:
                num = int(original)
                modified.extend([str(num + 1), str(num - 1), str(num + 100), "0", "999999"])
            except ValueError:
                modified.append("1")
        elif id_type in ("uuid", "query_uuid"):
            # Modify last character of UUID
            if len(original) > 1:
                last_char = original[-1]
                new_char = "a" if last_char != "a" else "b"
                modified.append(original[:-1] + new_char)
            modified.append("00000000-0000-0000-0000-000000000000")

        return modified

    def _test_id_enumeration(self):
        """Test IDOR by modifying IDs in URLs."""
        token = self.get_token_a()
        idor_found = False
        tested = 0

        for ep in self.endpoints:
            ids_found = self._find_ids_in_url(ep.url)
            if not ids_found:
                continue

            # Baseline request
            baseline = self.make_request(ep, token=token)
            if not self.is_success_status(baseline.response_status):
                continue

            for original_id, id_type, pattern_match in ids_found:
                modified_ids = self._modify_id(original_id, id_type)

                for new_id in modified_ids:
                    modified_url = ep.url.replace(original_id, new_id, 1)
                    evidence = self.make_request(
                        ep, token=token, override_url=modified_url
                    )
                    tested += 1

                    if self.is_success_status(evidence.response_status):
                        # Compare response to see if different data is returned
                        if evidence.response_body != baseline.response_body:
                            idor_found = True
                            self.add_result(
                                "id_enumeration",
                                TestStatus.FAIL,
                                f"IDOR: {ep.method} {modified_url} returned different data "
                                f"(ID {original_id} -> {new_id})",
                                endpoint_name=ep.full_name,
                                evidence=evidence,
                            )
                            self.log_finding(
                                severity=Severity.HIGH,
                                title=f"IDOR via ID enumeration on {ep.method} {ep.url}",
                                description=(
                                    f"Changing {id_type} ID from '{original_id}' to '{new_id}' "
                                    f"returned a successful response with different data."
                                ),
                                endpoint=f"{ep.method} {ep.url}",
                                evidence=evidence,
                                remediation=(
                                    "Implement object-level authorization checks. "
                                    "Verify the authenticated user has permission to access the requested resource."
                                ),
                            )

        if not idor_found:
            self.add_result(
                "id_enumeration",
                TestStatus.PASS,
                f"No IDOR found via ID enumeration ({tested} variations tested)",
            )

    def _test_cross_user_idor(self):
        """Test if User A can access User B's resources by swapping tokens."""
        token_a = self.get_token_a()
        token_b = self.get_token_b()

        if not token_a or not token_b:
            self.add_result("cross_user_idor", TestStatus.SKIP, "Need both User A and B tokens")
            return

        idor_found = False
        tested = 0

        for ep in self.endpoints:
            ids_found = self._find_ids_in_url(ep.url)
            if not ids_found:
                continue

            # First, get User B's response (to get IDs from their context)
            response_b = self.make_request(ep, token=token_b)
            if not self.is_success_status(response_b.response_status):
                continue

            # Try accessing same endpoint with User A's token
            evidence = self.make_request(ep, token=token_a)
            tested += 1

            if self.is_success_status(evidence.response_status):
                # If User A gets a success response with the same data as User B
                if evidence.response_body and response_b.response_body:
                    idor_found = True
                    self.add_result(
                        "cross_user_idor",
                        TestStatus.FAIL,
                        f"Cross-user IDOR: User A accessed {ep.method} {ep.url} with User B's resource ID",
                        endpoint_name=ep.full_name,
                        evidence=evidence,
                    )
                    self.log_finding(
                        severity=Severity.CRITICAL,
                        title=f"Cross-user IDOR on {ep.method} {ep.url}",
                        description=(
                            "User A was able to access resources belonging to User B "
                            "by using User A's authentication token with User B's resource identifiers."
                        ),
                        endpoint=f"{ep.method} {ep.url}",
                        evidence=evidence,
                        remediation=(
                            "Implement object-level authorization. Check that the authenticated user "
                            "owns or has permission to access the requested object."
                        ),
                    )

        if not idor_found:
            self.add_result(
                "cross_user_idor",
                TestStatus.PASS,
                f"No cross-user IDOR detected ({tested} endpoints tested)",
            )

    def _test_id_in_body(self):
        """Test IDOR by modifying IDs in request bodies."""
        token = self.get_token_a()
        idor_found = False
        tested = 0

        id_fields = ["id", "user_id", "userId", "account_id", "accountId", "owner_id", "ownerId"]

        for ep in self.endpoints:
            if not ep.body or not isinstance(ep.body, dict):
                continue

            for field in id_fields:
                if field not in ep.body:
                    continue

                original_value = ep.body[field]

                # Try modified values
                test_values = []
                if isinstance(original_value, int):
                    test_values = [original_value + 1, original_value - 1, 0, 999999]
                elif isinstance(original_value, str):
                    if original_value.isdigit():
                        num = int(original_value)
                        test_values = [str(num + 1), str(num - 1), "0"]
                    else:
                        test_values = ["test_idor_id", "00000000-0000-0000-0000-000000000000"]

                for test_val in test_values:
                    modified_body = dict(ep.body)
                    modified_body[field] = test_val

                    evidence = self.make_request(ep, token=token, override_body=modified_body)
                    tested += 1

                    if self.is_success_status(evidence.response_status):
                        idor_found = True
                        self.add_result(
                            "id_in_body",
                            TestStatus.FAIL,
                            f"IDOR in body: {ep.method} {ep.url} accepted modified '{field}' = {test_val}",
                            endpoint_name=ep.full_name,
                            evidence=evidence,
                        )
                        self.log_finding(
                            severity=Severity.HIGH,
                            title=f"IDOR via body parameter '{field}' on {ep.method} {ep.url}",
                            description=(
                                f"Modifying the '{field}' field in the request body from "
                                f"'{original_value}' to '{test_val}' returned a successful response."
                            ),
                            endpoint=f"{ep.method} {ep.url}",
                            evidence=evidence,
                            remediation="Validate that body-level resource IDs match the authenticated user's permissions.",
                        )
                        break  # Move to next endpoint
                if idor_found:
                    break

        if not idor_found:
            self.add_result(
                "id_in_body",
                TestStatus.PASS,
                f"No IDOR found via body parameter manipulation ({tested} variations tested)",
            )
