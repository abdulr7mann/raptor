import logging
import re

from api_pentest.core.models import Severity, TestStatus
from api_pentest.scenarios.base_scenario import BaseScenario

logger = logging.getLogger(__name__)


class S06PrivilegedAccess(BaseScenario):
    """S06 - Improperly Privileged Access testing."""

    SCENARIO_ID = "S06"
    SCENARIO_NAME = "Improperly Privileged Access"
    OWASP_ID = "API5:2023"
    OWASP_NAME = "Broken Function Level Authorization"

    ADMIN_PATH_PATTERN = re.compile(
        r"/(admin|management|internal|system|config|settings|users/\d+/roles|"
        r"roles|permissions|tenants|organizations|billing|audit)",
        re.IGNORECASE,
    )

    SERVICE_PATH_PATTERN = re.compile(
        r"/(service|worker|job|cron|webhook|callback|internal-api|batch)",
        re.IGNORECASE,
    )

    def get_test_cases(self) -> list[str]:
        cases = ["admin_endpoint_access"]
        if self.oauth and self.oauth_b:
            cases.append("horizontal_privilege_escalation")
        cases.append("privilege_param_escalation")
        cases.append("service_endpoint_access")
        return cases

    def execute_test(self, test_name: str):
        if test_name == "admin_endpoint_access":
            self._test_admin_endpoint_access()
        elif test_name == "horizontal_privilege_escalation":
            self._test_horizontal_privilege_escalation()
        elif test_name == "privilege_param_escalation":
            self._test_privilege_param_escalation()
        elif test_name == "service_endpoint_access":
            self._test_service_endpoint_access()

    def _test_admin_endpoint_access(self):
        """Test if regular user token can access admin endpoints."""
        token = self.get_token_a()
        if not token:
            self.add_result("admin_endpoint_access", TestStatus.SKIP, "No token")
            return

        admin_endpoints = [
            ep for ep in self.endpoints if self.ADMIN_PATH_PATTERN.search(ep.url)
        ]

        if not admin_endpoints:
            # Also check tags
            admin_endpoints = [
                ep for ep in self.endpoints
                if any("admin" in t.lower() for t in ep.tags)
            ]

        if not admin_endpoints:
            self.add_result(
                "admin_endpoint_access",
                TestStatus.SKIP,
                "No admin endpoints detected",
            )
            return

        accessible = 0
        tested = 0

        for ep in admin_endpoints:
            evidence = self.make_request(ep, token=token)
            tested += 1

            if self.is_real_success(evidence):
                accessible += 1
                self.add_result(
                    "admin_endpoint_access",
                    TestStatus.FAIL,
                    f"Admin endpoint accessible: {ep.method} {ep.url} (HTTP {evidence.response_status})",
                    endpoint_name=ep.full_name,
                    evidence=evidence,
                )
                self.log_finding(
                    severity=Severity.HIGH,
                    title=f"Admin endpoint accessible with regular token",
                    description=(
                        f"Regular user token was accepted by admin endpoint "
                        f"{ep.method} {ep.url} (HTTP {evidence.response_status})."
                    ),
                    endpoint=f"{ep.method} {ep.url}",
                    evidence=evidence,
                    remediation="Implement role-based access control (RBAC). Restrict admin endpoints to admin roles.",
                )

        if accessible == 0:
            self.add_result(
                "admin_endpoint_access",
                TestStatus.PASS,
                f"All {tested} admin endpoints properly restricted",
            )

    def _test_horizontal_privilege_escalation(self):
        """Test if User A can perform User B's actions."""
        token_a = self.get_token_a()
        token_b = self.get_token_b()

        if not token_a or not token_b:
            self.add_result(
                "horizontal_privilege_escalation",
                TestStatus.SKIP,
                "Need both User A and B tokens",
            )
            return

        escalation_found = False
        tested = 0

        # Test write operations (POST, PUT, PATCH, DELETE) with wrong user
        write_endpoints = [
            ep for ep in self.endpoints if ep.method.upper() in ("POST", "PUT", "PATCH", "DELETE")
        ]

        for ep in write_endpoints[:10]:
            # Baseline: User B performs the action
            baseline = self.make_request(ep, token=token_b)
            if not self.is_success_status(baseline.response_status):
                continue

            # Attack: User A tries the same action
            evidence = self.make_request(ep, token=token_a)
            tested += 1

            if self.is_real_success(evidence):
                escalation_found = True
                self.add_result(
                    "horizontal_privilege_escalation",
                    TestStatus.FAIL,
                    f"User A can perform User B's action: {ep.method} {ep.url}",
                    endpoint_name=ep.full_name,
                    evidence=evidence,
                )
                self.log_finding(
                    severity=Severity.HIGH,
                    title=f"Horizontal privilege escalation on {ep.method} {ep.url}",
                    description=(
                        "User A was able to perform a write operation on an endpoint "
                        "that User B also has access to, without proper user-level checks."
                    ),
                    endpoint=f"{ep.method} {ep.url}",
                    evidence=evidence,
                    remediation="Verify resource ownership in all write operations.",
                )

        if not escalation_found:
            self.add_result(
                "horizontal_privilege_escalation",
                TestStatus.PASS,
                f"No horizontal escalation detected ({tested} endpoints tested)",
            )

    def _test_privilege_param_escalation(self):
        """Test privilege escalation via request body parameters."""
        token = self.get_token_a()
        if not token:
            self.add_result("privilege_param_escalation", TestStatus.SKIP, "No token")
            return

        escalation_params = [
            {"role": "admin"},
            {"is_admin": True},
            {"admin": True},
            {"privilege": "admin"},
            {"access_level": "admin"},
            {"user_type": "admin"},
            {"permissions": ["admin", "superuser"]},
        ]

        escalation_found = False
        tested = 0

        # Target POST/PUT/PATCH endpoints with body
        write_endpoints = [
            ep for ep in self.endpoints
            if ep.method.upper() in ("POST", "PUT", "PATCH") and ep.body
        ]

        for ep in write_endpoints[:10]:
            for params in escalation_params:
                modified_body = dict(ep.body) if isinstance(ep.body, dict) else {}
                modified_body.update(params)

                evidence = self.make_request(ep, token=token, override_body=modified_body)
                tested += 1

                if self.is_real_success(evidence):
                    param_str = ", ".join(f"{k}={v}" for k, v in params.items())
                    # Check if the response reflects the escalation
                    response_lower = evidence.response_body.lower()
                    if any(
                        indicator in response_lower
                        for indicator in ["admin", "superuser", "elevated", "role"]
                    ):
                        escalation_found = True
                        self.add_result(
                            "privilege_param_escalation",
                            TestStatus.FAIL,
                            f"Privilege escalation via params ({param_str}) at {ep.method} {ep.url}",
                            endpoint_name=ep.full_name,
                            evidence=evidence,
                        )
                        self.log_finding(
                            severity=Severity.CRITICAL,
                            title=f"Privilege escalation via body parameters",
                            description=(
                                f"Adding {param_str} to the request body of "
                                f"{ep.method} {ep.url} was accepted and reflected in the response."
                            ),
                            endpoint=f"{ep.method} {ep.url}",
                            evidence=evidence,
                            remediation=(
                                "Never trust client-supplied role/privilege parameters. "
                                "Set roles server-side only."
                            ),
                        )
                        break

        if not escalation_found:
            self.add_result(
                "privilege_param_escalation",
                TestStatus.PASS,
                f"No parameter-based privilege escalation detected ({tested} tested)",
            )

    def _test_service_endpoint_access(self):
        """Test if user tokens can access service/internal endpoints."""
        token = self.get_token_a()
        if not token:
            self.add_result("service_endpoint_access", TestStatus.SKIP, "No token")
            return

        service_endpoints = [
            ep for ep in self.endpoints if self.SERVICE_PATH_PATTERN.search(ep.url)
        ]

        if not service_endpoints:
            self.add_result(
                "service_endpoint_access",
                TestStatus.SKIP,
                "No service/internal endpoints detected",
            )
            return

        accessible = 0
        tested = 0

        for ep in service_endpoints:
            evidence = self.make_request(ep, token=token)
            tested += 1

            if self.is_real_success(evidence):
                accessible += 1
                self.log_finding(
                    severity=Severity.MEDIUM,
                    title=f"Service endpoint accessible with user token",
                    description=(
                        f"User token was accepted by service endpoint "
                        f"{ep.method} {ep.url}."
                    ),
                    endpoint=f"{ep.method} {ep.url}",
                    evidence=evidence,
                    remediation="Restrict service endpoints to service accounts only.",
                )

        status = TestStatus.FAIL if accessible > 0 else TestStatus.PASS
        self.add_result(
            "service_endpoint_access",
            status,
            f"{accessible}/{tested} service endpoints accessible with user token",
        )
