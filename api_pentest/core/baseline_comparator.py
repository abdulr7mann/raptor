"""Baseline comparison for response body diff detection.

Uses DeepDiff for structural JSON comparison with dynamic field exclusion
(timestamps, UUIDs, etc.) to identify meaningful differences.
"""

import json
import re
from typing import Any

from deepdiff import DeepDiff


class BaselineComparator:
    """Compares response bodies to detect meaningful differences.

    Ignores dynamic values (timestamps, UUIDs, incrementing IDs) when
    determining if two JSON structures are meaningfully different.
    """

    # Patterns for detecting dynamic values that should be ignored
    DYNAMIC_VALUE_PATTERNS = [
        # ISO timestamps: 2024-01-15T10:30:00Z, 2024-01-15 10:30:00
        re.compile(r'^\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}'),
        # UUIDs: 550e8400-e29b-41d4-a716-446655440000
        re.compile(r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$', re.IGNORECASE),
        # Unix timestamps (10-13 digits): 1705320600, 1705320600123
        re.compile(r'^\d{10,13}$'),
    ]

    def has_meaningful_diff(self, baseline_body: str, test_body: str) -> bool:
        """Check if test response differs meaningfully from baseline.

        Args:
            baseline_body: Response body from baseline request
            test_body: Response body from test request

        Returns:
            True if there are meaningful differences, False if equivalent
        """
        baseline_json = self._parse_json(baseline_body)
        test_json = self._parse_json(test_body)

        # If neither is JSON, fall back to string comparison
        if baseline_json is None and test_json is None:
            return baseline_body.strip() != test_body.strip()

        # If only one is JSON, they differ
        if (baseline_json is None) != (test_json is None):
            return True

        # Both are JSON - use DeepDiff with dynamic value exclusion
        diff = DeepDiff(
            baseline_json,
            test_json,
            ignore_order=True,
            exclude_obj_callback=self._is_dynamic_value,
        )

        return bool(diff)

    def has_structure_change(self, baseline_body: str, test_body: str) -> bool:
        """Check if top-level JSON structure changed (added/removed keys).

        Only checks for key additions/removals, not value changes.

        Args:
            baseline_body: Response body from baseline request
            test_body: Response body from test request

        Returns:
            True if structure changed, False otherwise
        """
        baseline_json = self._parse_json(baseline_body)
        test_json = self._parse_json(test_body)

        # Can't compare structure if not both JSON dicts
        if baseline_json is None or test_json is None:
            return False

        baseline_keys = set(baseline_json.keys())
        test_keys = set(test_json.keys())

        return baseline_keys != test_keys

    def _is_dynamic_value(self, obj: Any, path: str) -> bool:
        """DeepDiff callback to exclude dynamic values from comparison.

        Args:
            obj: The value being compared
            path: DeepDiff path to the value

        Returns:
            True to exclude this value from comparison
        """
        if not isinstance(obj, str):
            return False

        for pattern in self.DYNAMIC_VALUE_PATTERNS:
            if pattern.match(obj):
                return True

        return False

    def _parse_json(self, body: str) -> dict | None:
        """Safely parse JSON body, returning None for non-JSON.

        Args:
            body: Response body string

        Returns:
            Parsed dict or None if not valid JSON dict
        """
        if not body:
            return None
        try:
            parsed = json.loads(body)
            if isinstance(parsed, dict):
                return parsed
            return None
        except (json.JSONDecodeError, TypeError, ValueError):
            return None
