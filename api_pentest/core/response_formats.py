"""Response format handling for parsing JSON, XML, and text responses.

Provides safe parsing with defusedxml for XXE protection and graceful
fallback for unknown content types.
"""

import json
import logging
from typing import Any

import defusedxml.ElementTree as ET

from api_pentest.core.models import Evidence

logger = logging.getLogger(__name__)


class ResponseFormatHandler:
    """Parses HTTP response bodies based on Content-Type.

    Supports JSON, XML (with XXE protection via defusedxml), and plain text.
    Returns parsed data with format type indicator, or raw text as fallback.
    """

    JSON_TYPES: frozenset[str] = frozenset({
        "application/json",
        "application/vnd.api+json",
        "application/hal+json",
        "application/problem+json",
        "text/json",
    })

    XML_TYPES: frozenset[str] = frozenset({
        "application/xml",
        "text/xml",
        "application/soap+xml",
        "application/xhtml+xml",
        "application/atom+xml",
        "application/rss+xml",
    })

    def detect_content_type(self, evidence: Evidence) -> str:
        """Extract base Content-Type from response headers.

        Strips charset, boundary, and other parameters.

        Args:
            evidence: Evidence object with response_headers

        Returns:
            Lowercase base content type (e.g. "application/json"),
            or empty string if not found.
        """
        for header_name, header_val in evidence.response_headers.items():
            if header_name.lower() == "content-type":
                # Strip parameters (charset, boundary, etc.)
                base_type = header_val.split(";")[0].strip().lower()
                return base_type
        return ""

    def parse(self, evidence: Evidence) -> tuple[Any, str]:
        """Parse response body based on Content-Type.

        Args:
            evidence: Evidence object with response_body and response_headers

        Returns:
            Tuple of (parsed_data, format_type) where format_type is one of:
            - "json": Successfully parsed as JSON
            - "xml": Successfully parsed as XML (returns ElementTree Element)
            - "text": Returned as plain text (fallback)
            - "empty": Response body was empty or None
        """
        body = evidence.response_body

        # Handle empty body
        if not body:
            return None, "empty"

        content_type = self.detect_content_type(evidence)

        # Try JSON parsing
        if content_type in self.JSON_TYPES or not content_type:
            try:
                parsed = json.loads(body)
                return parsed, "json"
            except json.JSONDecodeError as e:
                if content_type in self.JSON_TYPES:
                    logger.debug("JSON parse failed for %s: %s", content_type, e)
                # Fall through to try XML or return text

        # Try XML parsing (with XXE protection)
        if content_type in self.XML_TYPES:
            try:
                # defusedxml protects against XXE attacks
                element = ET.fromstring(body)
                return element, "xml"
            except ET.ParseError as e:
                logger.debug("XML parse failed for %s: %s", content_type, e)
                # Fall through to return text

        # Fallback: return raw text
        return body, "text"

    def parse_json_safe(self, evidence: Evidence) -> dict | list | None:
        """Convenience method to parse JSON or return None.

        Args:
            evidence: Evidence object with response_body

        Returns:
            Parsed JSON as dict or list, or None if parsing fails
            or body is not JSON.
        """
        body = evidence.response_body
        if not body:
            return None

        try:
            parsed = json.loads(body)
            if isinstance(parsed, (dict, list)):
                return parsed
            return None
        except json.JSONDecodeError as e:
            logger.debug("JSON parse failed in parse_json_safe: %s", e)
            return None
