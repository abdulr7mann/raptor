#!/usr/bin/env python3
"""
API Pentest Toolkit - CLI Entry Point

Usage:
    python run_pentest.py --input collection.json --config pentest.yaml
    python run_pentest.py --input swagger.yaml --config pentest.yaml --scenarios s01,s03
    python run_pentest.py --input collection.json --env my_env.json --config pentest.yaml
    python run_pentest.py --input collection.json --config pentest.yaml --list-endpoints
"""

import argparse
import logging
import sys
from pathlib import Path

import yaml

from api_pentest.runner import PentestRunner


def load_config(config_path: str, cli_overrides: dict) -> dict:
    """Load YAML config and merge CLI overrides."""
    config = {}

    if config_path and Path(config_path).exists():
        with open(config_path, "r", encoding="utf-8") as f:
            config = yaml.safe_load(f) or {}

    # Apply CLI overrides
    if cli_overrides.get("input"):
        config["input_file"] = cli_overrides["input"]
    if cli_overrides.get("url"):
        config["discovery_url"] = cli_overrides["url"]
    if cli_overrides.get("env"):
        config["environment_file"] = cli_overrides["env"]
    if cli_overrides.get("base_url"):
        config["base_url"] = cli_overrides["base_url"]
    if cli_overrides.get("output_dir"):
        config["output_dir"] = cli_overrides["output_dir"]

    return config


def main():
    parser = argparse.ArgumentParser(
        description="API Penetration Testing Toolkit",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s --input collection.json --config pentest.yaml
  %(prog)s --input swagger.yaml --config pentest.yaml --scenarios s01,s03,s05
  %(prog)s --input collection.json --env env.json --config pentest.yaml
  %(prog)s --input collection.json --config pentest.yaml --list-endpoints
  %(prog)s --url http://api.example.com --config pentest.yaml
        """,
    )

    parser.add_argument(
        "--input", "-i",
        help="Path to Postman collection (.json) or Swagger/OpenAPI spec (.json/.yaml)",
    )
    parser.add_argument(
        "--url", "-u",
        help="Base URL for auto-discovery (alternative to --input). "
             "Discovers API spec at common paths (/openapi.json, /swagger.json, etc.), "
             "falls back to endpoint fuzzing if no spec found.",
    )
    parser.add_argument(
        "--config", "-c",
        default="pentest.yaml",
        help="Path to pentest configuration file (default: pentest.yaml)",
    )
    parser.add_argument(
        "--env", "-e",
        help="Path to Postman environment file (.json) for variable resolution",
    )
    parser.add_argument(
        "--scenarios", "-s",
        help="Comma-separated list of scenarios to run (e.g., s01,s03,s05). Default: all",
    )
    parser.add_argument(
        "--base-url",
        help="Override base URL for all endpoints",
    )
    parser.add_argument(
        "--output-dir", "-o",
        help="Directory for report output (default: ./reports)",
    )
    parser.add_argument(
        "--list-endpoints",
        action="store_true",
        help="List all discovered endpoints without running tests",
    )
    parser.add_argument(
        "--verbose", "-v",
        action="store_true",
        help="Enable verbose/debug logging",
    )
    parser.add_argument(
        "--relevance-threshold",
        type=float,
        default=0.3,
        metavar="SCORE",
        help="Minimum relevance score (0.0-1.0) to run a test. "
             "Lower = more tests, higher coverage. "
             "Higher = faster, fewer tests. Default: 0.3",
    )
    parser.add_argument(
        "--fast",
        action="store_true",
        help="Fast mode: raise relevance threshold to 0.6 for quicker scans "
             "(reduces test coverage)",
    )

    args = parser.parse_args()

    # Validate --input XOR --url required
    if not args.input and not args.url:
        parser.error("Either --input or --url is required")
    if args.input and args.url:
        parser.error("Cannot use both --input and --url")

    # Setup logging
    log_level = logging.DEBUG if args.verbose else logging.INFO
    logging.basicConfig(
        level=log_level,
        format="%(asctime)s [%(levelname)s] %(name)s: %(message)s",
        datefmt="%H:%M:%S",
    )

    # Validate input file exists (only when using --input)
    if args.input and not Path(args.input).exists():
        print(f"Error: Input file not found: {args.input}", file=sys.stderr)
        sys.exit(1)

    # Load config
    cli_overrides = {
        "input": args.input,
        "url": args.url,
        "env": args.env,
        "base_url": args.base_url,
        "output_dir": args.output_dir,
    }
    config = load_config(args.config, cli_overrides)

    # Apply relevance threshold from CLI
    if args.relevance_threshold:
        config["relevance_threshold"] = args.relevance_threshold

    # Fast mode overrides threshold
    if args.fast:
        config["relevance_threshold"] = max(0.6, config.get("relevance_threshold", 0.3))
        print(f"Fast mode enabled: relevance threshold set to {config['relevance_threshold']}")

    # Validate threshold range
    threshold = config.get("relevance_threshold", 0.3)
    if not 0.0 <= threshold <= 1.0:
        print(f"Error: relevance-threshold must be between 0.0 and 1.0", file=sys.stderr)
        sys.exit(1)

    # Create runner
    runner = PentestRunner(config)

    if args.list_endpoints:
        runner.list_endpoints()
        return

    # Parse scenario list
    scenario_ids = None
    if args.scenarios:
        scenario_ids = [s.strip() for s in args.scenarios.split(",")]

    # Run pentest
    try:
        runner.run(scenario_ids=scenario_ids)
    except KeyboardInterrupt:
        print("\nPentest interrupted by user.")
        sys.exit(130)
    except Exception as e:
        print(f"\nFatal error: {e}", file=sys.stderr)
        if args.verbose:
            import traceback
            traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
