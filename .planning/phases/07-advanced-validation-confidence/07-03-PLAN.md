---
phase: 07-advanced-validation-confidence
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - api_pentest/reporting/report_generator.py
  - api_pentest/reporting/templates/report.html
autonomous: true

must_haves:
  truths:
    - "HTML report displays confidence badge on each finding (CONFIRMED green, LIKELY yellow, UNCERTAIN gray)"
    - "Confidence explanation text appears below the badge"
    - "Filter dropdown allows users to filter findings by confidence level"
    - "Findings are ordered by severity first, then confidence second"
  artifacts:
    - path: "api_pentest/reporting/report_generator.py"
      provides: "Confidence badge rendering and sorting"
      contains: "confidence"
    - path: "api_pentest/reporting/templates/report.html"
      provides: "Confidence badges, explanations, and filter UI"
      contains: "confidence-badge"
  key_links:
    - from: "api_pentest/reporting/report_generator.py"
      to: "api_pentest/core/models.py"
      via: "ConfidenceLevel import for sorting"
      pattern: "ConfidenceLevel"
---

<objective>
Update the HTML report to display confidence levels with visual badges,
explanation text, and filtering capability.

Purpose: Users should be able to see at a glance which findings are CONFIRMED,
LIKELY, or UNCERTAIN, understand why each level was assigned, and filter to
focus on high-certainty findings first.

Output:
- Confidence badges styled with appropriate colors (green/yellow/gray)
- Explanation text below badges listing detected signals
- Filter dropdown to show/hide findings by confidence level
- Sorting: severity first, confidence second
</objective>

<execution_context>
@/home/abdulr7man/.claude/get-shit-done/workflows/execute-plan.md
@/home/abdulr7man/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-advanced-validation-confidence/07-CONTEXT.md
@.planning/phases/07-advanced-validation-confidence/07-01-SUMMARY.md
@api_pentest/reporting/report_generator.py
@api_pentest/reporting/templates/report.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update report_generator.py for confidence sorting and data</name>
  <files>api_pentest/reporting/report_generator.py</files>
  <action>
    1. Add ConfidenceLevel import at top (if needed for type checking):
       Already imports from models, add ConfidenceLevel to the import

    2. Add confidence sort order constant after _SEVERITY_ORDER:
       ```python
       _CONFIDENCE_ORDER = {
           "CONFIRMED": 0,
           "LIKELY": 1,
           "UNCERTAIN": 2,
       }
       ```

    3. Update sorted_findings in generate_html() to sort by severity first, then confidence:
       ```python
       sorted_findings = sorted(
           findings,
           key=lambda f: (
               _SEVERITY_ORDER.get(f.severity, 99),
               _CONFIDENCE_ORDER.get(f.confidence.value if hasattr(f, 'confidence') else "UNCERTAIN", 2),
           )
       )
       ```

    4. Ensure finding_dicts includes confidence fields from Finding.to_dict():
       The to_dict() method already includes confidence fields from Plan 01,
       so no additional work needed here.

    5. Add confidence counts to summary dict in _build_summary():
       ```python
       confidence_counts = {"CONFIRMED": 0, "LIKELY": 0, "UNCERTAIN": 0}
       for f in findings:
           conf = f.confidence.value if hasattr(f, 'confidence') else "UNCERTAIN"
           if conf in confidence_counts:
               confidence_counts[conf] += 1

       # Add to return dict
       return {
           # ... existing fields ...
           "confidence": confidence_counts,
       }
       ```
  </action>
  <verify>
    Run: python -c "
from api_pentest.reporting.report_generator import ReportGenerator, _CONFIDENCE_ORDER
assert _CONFIDENCE_ORDER['CONFIRMED'] == 0
assert _CONFIDENCE_ORDER['LIKELY'] == 1
assert _CONFIDENCE_ORDER['UNCERTAIN'] == 2
print('Confidence order OK')
"
  </verify>
  <done>
    - _CONFIDENCE_ORDER constant exists with correct ordering
    - generate_html() sorts findings by severity first, confidence second
    - _build_summary() includes confidence counts
  </done>
</task>

<task type="auto">
  <name>Task 2: Add confidence badges, explanations, and filter to HTML template</name>
  <files>api_pentest/reporting/templates/report.html</files>
  <action>
    **Add CSS styles** (inside the existing style block, after .badge-info):
    ```css
    /* Confidence badges */
    .confidence-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 8px;
    }
    .badge-confirmed { background: #3fb95022; color: #3fb950; border: 1px solid #3fb950; }
    .badge-likely { background: #d2992222; color: #d29922; border: 1px solid #d29922; }
    .badge-uncertain { background: #8b949e22; color: #8b949e; border: 1px solid #8b949e; }
    .confidence-explanation { color: #8b949e; font-size: 0.9rem; margin-top: 0.5rem; font-style: italic; }
    .filter-controls { margin: 1rem 0; padding: 0.8rem; background: #161b22; border-radius: 8px; border: 1px solid #21262d; }
    .filter-controls label { margin-right: 0.5rem; color: #c9d1d9; }
    .filter-controls select { background: #0d1117; color: #c9d1d9; border: 1px solid #21262d; padding: 0.4rem 0.8rem; border-radius: 4px; }
    ```

    **Add filter dropdown** (just before the Findings section, after summary grid):
    ```html
    <div class="filter-controls">
      <label for="confidence-filter">Filter by confidence:</label>
      <select id="confidence-filter" onchange="filterFindings()">
        <option value="all">All findings</option>
        <option value="CONFIRMED">CONFIRMED only</option>
        <option value="LIKELY">CONFIRMED + LIKELY</option>
      </select>
      <span style="margin-left: 1rem; color: #8b949e;">
        ({{ summary.confidence.CONFIRMED }} confirmed, {{ summary.confidence.LIKELY }} likely, {{ summary.confidence.UNCERTAIN }} uncertain)
      </span>
    </div>
    ```

    **Add confidence badge to finding cards** (after the severity badge, before h3):
    ```html
    {% if finding.confidence == 'CONFIRMED' %}
    <span class="confidence-badge badge-confirmed">CONFIRMED</span>
    {% elif finding.confidence == 'LIKELY' %}
    <span class="confidence-badge badge-likely">LIKELY</span>
    {% else %}
    <span class="confidence-badge badge-uncertain">UNCERTAIN</span>
    {% endif %}
    ```

    **Add confidence explanation** (after the description paragraph, before endpoint):
    ```html
    {% if finding.confidence_explanation %}
    <p class="confidence-explanation">{{ finding.confidence_explanation }}</p>
    {% endif %}
    ```

    **Add data attribute to finding cards** for filtering (modify the div.finding-card opening tag):
    ```html
    <div class="finding-card" data-confidence="{{ finding.confidence }}">
    ```

    **Add JavaScript filter function** (at the end of body, before closing body tag):
    ```html
    <script>
    function filterFindings() {
      const filter = document.getElementById('confidence-filter').value;
      const cards = document.querySelectorAll('.finding-card');

      cards.forEach(card => {
        const confidence = card.dataset.confidence || 'UNCERTAIN';
        let visible = true;

        if (filter === 'CONFIRMED') {
          visible = confidence === 'CONFIRMED';
        } else if (filter === 'LIKELY') {
          visible = confidence === 'CONFIRMED' || confidence === 'LIKELY';
        }
        // 'all' shows everything

        card.style.display = visible ? 'block' : 'none';
      });

      // Update visible count
      const visibleCount = document.querySelectorAll('.finding-card[style*="block"], .finding-card:not([style])').length;
    }
    </script>
    ```

    **Add confidence summary cards** to the summary grid (after the existing severity cards):
    ```html
    <div class="summary-card"><div class="number" style="color: #3fb950;">{{ summary.confidence.CONFIRMED }}</div><div class="label">Confirmed</div></div>
    <div class="summary-card"><div class="number" style="color: #d29922;">{{ summary.confidence.LIKELY }}</div><div class="label">Likely</div></div>
    <div class="summary-card"><div class="number" style="color: #8b949e;">{{ summary.confidence.UNCERTAIN }}</div><div class="label">Uncertain</div></div>
    ```
  </action>
  <verify>
    Verify template contains confidence elements:
    - grep "confidence-badge" api_pentest/reporting/templates/report.html
    - grep "filterFindings" api_pentest/reporting/templates/report.html
    - grep "confidence_explanation" api_pentest/reporting/templates/report.html
  </verify>
  <done>
    - Confidence badge CSS styles added (green CONFIRMED, yellow LIKELY, gray UNCERTAIN)
    - Filter dropdown before findings section with three options
    - Each finding card has confidence badge next to severity badge
    - Confidence explanation displayed when present
    - JavaScript filter function shows/hides findings by confidence
    - Summary grid includes confidence counts
  </done>
</task>

</tasks>

<verification>
1. CSS check: `grep -c "badge-confirmed" api_pentest/reporting/templates/report.html` should return > 0
2. Filter check: `grep -c "filterFindings" api_pentest/reporting/templates/report.html` should return > 0
3. Generator check: `python -c "from api_pentest.reporting.report_generator import _CONFIDENCE_ORDER; print(_CONFIDENCE_ORDER)"`
4. Integration: Generate a test report and verify badges appear in HTML output
</verification>

<success_criteria>
- Confidence badges display with correct colors for each level
- Filter dropdown allows filtering by confidence level
- Explanations appear below badges when present
- Findings sorted by severity first, confidence second
- Summary includes confidence counts
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-validation-confidence/07-03-SUMMARY.md`
</output>
