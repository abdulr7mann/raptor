---
phase: 04-prerequisite-aware-testing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - api_pentest/scenarios/s07_access_controls.py
  - api_pentest/scenarios/s11_security_misconfig.py
  - api_pentest/reporting/report_generator.py
  - api_pentest/reporting/templates/report.html
autonomous: true

must_haves:
  truths:
    - "CORS bypass tests in S07 and S11 skip when no CORS headers are detected on the target"
    - "HTML report has a 'Not Applicable' section showing tests skipped due to unmet preconditions"
    - "Summary card in report shows count of not-applicable tests"
    - "Prerequisite skips are distinguishable from other skips in the report"
    - "Tests skipped for non-prerequisite reasons (no endpoints, no token) are NOT shown in the Not Applicable section"
  artifacts:
    - path: "api_pentest/scenarios/s07_access_controls.py"
      provides: "CORS prerequisite gate on _test_cors_misconfiguration()"
      contains: "Precondition not met"
    - path: "api_pentest/scenarios/s11_security_misconfig.py"
      provides: "CORS prerequisite gate on _test_cors_deep()"
      contains: "Precondition not met"
    - path: "api_pentest/reporting/report_generator.py"
      provides: "Prerequisite skip filtering and template variable passing"
      contains: "skipped_prerequisites"
    - path: "api_pentest/reporting/templates/report.html"
      provides: "Not Applicable section between Findings and Test Results"
      contains: "Not Applicable"
  key_links:
    - from: "api_pentest/scenarios/s07_access_controls.py"
      to: "api_pentest/scenarios/base_scenario.py"
      via: "self.get_prerequisite('cors') call in _test_cors_misconfiguration()"
      pattern: "get_prerequisite.*cors"
    - from: "api_pentest/reporting/report_generator.py"
      to: "api_pentest/reporting/templates/report.html"
      via: "skipped_prerequisites template variable"
      pattern: "skipped_prerequisites"
    - from: "api_pentest/reporting/report_generator.py"
      to: "api_pentest/core/models.py"
      via: "TestResult.details prefix 'Precondition not met:' filtering"
      pattern: "Precondition not met"
---

<objective>
Gate CORS bypass tests behind CORS detection and add a "Not Applicable" section to the HTML report showing prerequisite-skipped tests with reasons.

Purpose: CORS tests in S07 and S11 waste requests probing for CORS bypass when no CORS headers exist. The HTML report needs visibility into why tests were skipped, per CONTEXT.md requirement that skips appear in both console and report. This completes Phase 4's success criteria: "Skipped tests are logged with reason (precondition not met) rather than silently omitted."

Output: S07/S11 CORS gating, HTML report "Not Applicable" section with summary card, complete prerequisite skip visibility.
</objective>

<execution_context>
@/home/abdulr7man/.claude/get-shit-done/workflows/execute-plan.md
@/home/abdulr7man/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-prerequisite-aware-testing/04-RESEARCH.md
@.planning/phases/04-prerequisite-aware-testing/04-01-SUMMARY.md

@api_pentest/scenarios/s07_access_controls.py
@api_pentest/scenarios/s11_security_misconfig.py
@api_pentest/reporting/report_generator.py
@api_pentest/reporting/templates/report.html
@api_pentest/core/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate S07 and S11 CORS tests behind CORS prerequisite</name>
  <files>
    api_pentest/scenarios/s07_access_controls.py
    api_pentest/scenarios/s11_security_misconfig.py
  </files>
  <action>
MODIFY `api_pentest/scenarios/s07_access_controls.py`:

1. Add import at top: `from api_pentest.core.prerequisite_detector import DetectionStatus`

2. In `_test_cors_misconfiguration()` (around line 202), after the method signature and before `token = self.get_token_a()`, add the prerequisite gate:
```python
# Check if CORS is configured before testing bypass
cors_prereq = self.get_prerequisite("cors")
if cors_prereq and cors_prereq.status == DetectionStatus.ABSENT:
    self.add_skip_result(
        test_name="cors_misconfiguration",
        reason=cors_prereq.reason,
        control="cors",
    )
    return
```

IMPORTANT: Do NOT gate other S07 tests (access_without_auth, privilege_escalation, undocumented_methods, debug_endpoints). Only cors_misconfiguration gets the CORS prerequisite check.

MODIFY `api_pentest/scenarios/s11_security_misconfig.py`:

1. Add import at top: `from api_pentest.core.prerequisite_detector import DetectionStatus`

2. In `_test_cors_deep()` (around line 393), after the method signature and before `token = self.get_token_a()`, add the prerequisite gate:
```python
# Check if CORS is configured before testing deep CORS issues
cors_prereq = self.get_prerequisite("cors")
if cors_prereq and cors_prereq.status == DetectionStatus.ABSENT:
    self.add_skip_result(
        test_name="cors_deep_analysis",
        reason=cors_prereq.reason,
        control="cors",
    )
    return
```

IMPORTANT: Do NOT gate _test_security_headers() in S11. That test reports MISSING headers (including CSP) as findings -- absence IS the finding, not a bypass. Only _test_cors_deep() gets the CORS gate. Also do NOT gate _test_error_verbosity() or any other S11 test.
  </action>
  <verify>
Run `python -c "from api_pentest.scenarios.s07_access_controls import S07AccessControls; print('OK')"` succeeds.
Run `python -c "from api_pentest.scenarios.s11_security_misconfig import S11SecurityMisconfig; print('OK')"` succeeds.
`grep -n "Precondition not met" api_pentest/scenarios/s07_access_controls.py` shows the gate in _test_cors_misconfiguration.
`grep -n "Precondition not met" api_pentest/scenarios/s11_security_misconfig.py` shows the gate in _test_cors_deep.
`grep -c "get_prerequisite" api_pentest/scenarios/s11_security_misconfig.py` returns exactly 1 (only in _test_cors_deep, not in _test_security_headers).
  </verify>
  <done>
S07._test_cors_misconfiguration() and S11._test_cors_deep() are gated behind CORS prerequisite. When CORS is ABSENT, tests skip with logged reason. S11._test_security_headers() remains ungated (missing headers IS the finding). All other S07/S11 tests unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Not Applicable" section to HTML report with prerequisite skip visibility</name>
  <files>
    api_pentest/reporting/report_generator.py
    api_pentest/reporting/templates/report.html
  </files>
  <action>
MODIFY `api_pentest/reporting/report_generator.py`:

1. In `generate_html()`, after building `result_dicts` and before `template.render()`, add prerequisite skip extraction:
```python
# Extract prerequisite-skipped tests for "Not Applicable" section
# Convention: prerequisite skips have details starting with "Precondition not met:"
prerequisite_skips = []
for r in results:
    if r.status == TestStatus.SKIP and r.details.startswith("Precondition not met:"):
        prerequisite_skips.append({
            "scenario_id": r.scenario_id,
            "test_name": r.test_name,
            "endpoint": r.endpoint_name,
            "reason": r.details.replace("Precondition not met: ", "", 1),
        })
```

2. Add `not_applicable` count to the summary dict. In `_build_summary()`, add to the returned dict:
```python
"not_applicable": sum(
    1 for r in results
    if r.status == TestStatus.SKIP
    and r.details.startswith("Precondition not met:")
),
```

3. In the `template.render()` call, add `skipped_prerequisites=prerequisite_skips` as a template variable:
```python
html = template.render(
    timestamp=datetime.now(timezone.utc).isoformat(),
    summary=summary,
    findings=finding_dicts,
    results=result_dicts,
    skipped_prerequisites=prerequisite_skips,
)
```

4. Also update `generate_json()` to include the not_applicable count in its summary by calling `_build_summary()` which now includes it.

MODIFY `api_pentest/reporting/templates/report.html`:

1. Add a "Not Applicable" summary card in the summary-grid section, after the Info card:
```html
<div class="summary-card"><div class="number" style="color: #8b949e;">{{ summary.not_applicable }}</div><div class="label">Not Applicable</div></div>
```

2. Add a "Not Applicable" section BETWEEN the Findings section and the Test Results section (after the `{% endif %}` that closes the findings block, before `<h2>Test Results</h2>`):
```html
<h2>Not Applicable</h2>
{% if skipped_prerequisites %}
<p style="color: #8b949e;">The following tests were skipped because their preconditions were not met on the target:</p>
<table>
<tr><th>Scenario</th><th>Test</th><th>Endpoint</th><th>Reason</th></tr>
{% for skip in skipped_prerequisites %}
<tr>
  <td>{{ skip.scenario_id }}</td>
  <td>{{ skip.test_name }}</td>
  <td>{{ skip.endpoint }}</td>
  <td>{{ skip.reason }}</td>
</tr>
{% endfor %}
</table>
{% else %}
<p style="color: #3fb950;">All test preconditions were met.</p>
{% endif %}
```

IMPORTANT: The "Precondition not met:" prefix convention is the filtering mechanism. Non-prerequisite skips (like "No endpoints", "No token") do NOT start with this prefix and will NOT appear in the Not Applicable section. They still appear in the Test Results table as before.

IMPORTANT: Do NOT modify the TestResult dataclass in models.py. Use the string prefix convention per the RESEARCH.md recommendation (Option A).
  </action>
  <verify>
Run `python -c "from api_pentest.reporting.report_generator import ReportGenerator; print('OK')"` succeeds.
`grep -n "not_applicable" api_pentest/reporting/report_generator.py` shows the summary field.
`grep -n "skipped_prerequisites" api_pentest/reporting/report_generator.py` shows the template variable.
`grep -n "Not Applicable" api_pentest/reporting/templates/report.html` shows the section heading.
`grep -n "Precondition not met" api_pentest/reporting/report_generator.py` shows the filtering logic.
  </verify>
  <done>
HTML report includes "Not Applicable" summary card and dedicated section with table of prerequisite-skipped tests. Prerequisite skips are filtered by "Precondition not met:" prefix convention. Non-prerequisite skips remain in Test Results only. JSON report summary includes not_applicable count.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from api_pentest.scenarios.s07_access_controls import S07AccessControls; from api_pentest.scenarios.s11_security_misconfig import S11SecurityMisconfig; from api_pentest.reporting.report_generator import ReportGenerator; print('All imports OK')"` passes
2. S07 has exactly 1 `get_prerequisite` call (in _test_cors_misconfiguration only)
3. S11 has exactly 1 `get_prerequisite` call (in _test_cors_deep only, NOT in _test_security_headers)
4. report.html contains "Not Applicable" section between Findings and Test Results
5. report_generator.py filters prerequisite skips using "Precondition not met:" prefix
6. summary dict includes "not_applicable" count
</verification>

<success_criteria>
- S07._test_cors_misconfiguration() skips when CORS prerequisite is ABSENT
- S11._test_cors_deep() skips when CORS prerequisite is ABSENT
- S11._test_security_headers() is NOT gated (missing headers is a legitimate finding)
- HTML report has "Not Applicable" summary card and section with prerequisite-skipped test table
- Prerequisite skips are distinguished from other skips by "Precondition not met:" prefix
- JSON report summary includes not_applicable count
</success_criteria>

<output>
After completion, create `.planning/phases/04-prerequisite-aware-testing/04-02-SUMMARY.md`
</output>
