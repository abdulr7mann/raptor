---
phase: 01-evidence-report-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api_pentest/core/models.py
  - api_pentest/reporting/report_generator.py
  - api_pentest/reporting/templates/report.html
  - api_pentest/runner.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "HTML report renders evidence blocks with syntax highlighting and no raw HTML entities visible"
    - "Opening an HTML report containing <script>alert(1)</script> in a response body does NOT execute JavaScript"
    - "Evidence.to_dict() returns full response body without any truncation"
    - "Duplicate findings (same title + endpoint) are collapsed to a single finding in report output"
    - "Findings in HTML report are sorted by severity: Critical > High > Medium > Low > Info"
  artifacts:
    - path: "api_pentest/reporting/report_generator.py"
      provides: "Jinja2-based report generator with autoescape and Pygments evidence highlighting"
      contains: "Environment"
    - path: "api_pentest/reporting/templates/report.html"
      provides: "Jinja2 HTML template for pentest report"
      contains: "{% for finding in findings %}"
    - path: "api_pentest/core/models.py"
      provides: "Evidence.to_dict() without response body truncation"
      contains: "\"body\": self.response_body"
    - path: "api_pentest/runner.py"
      provides: "Post-processing deduplication of findings before report generation"
      contains: "deduplicate_findings"
    - path: "requirements.txt"
      provides: "Pygments dependency declaration"
      contains: "pygments"
  key_links:
    - from: "api_pentest/reporting/report_generator.py"
      to: "api_pentest/reporting/templates/report.html"
      via: "Jinja2 FileSystemLoader or PackageLoader"
      pattern: "get_template.*report\\.html"
    - from: "api_pentest/reporting/report_generator.py"
      to: "pygments"
      via: "Pygments highlight() for evidence blocks"
      pattern: "from pygments import highlight"
    - from: "api_pentest/runner.py"
      to: "deduplication function"
      via: "deduplicate_findings() called before _generate_reports()"
      pattern: "deduplicate_findings.*all_findings"
---

<objective>
Rewrite the report generator to use Jinja2 with autoescape and Pygments syntax highlighting, remove evidence truncation, and add finding deduplication.

Purpose: The current report generator uses manual str.replace() with an inline HTML template string, has an XSS vulnerability in evidence blocks (response bodies inserted without escaping), truncates evidence bodies at 2000 chars in the model and 500 chars in the template, and has no deduplication. This plan fixes all four issues: migrates to Jinja2 autoescape (RPT-03), removes truncation (per CONTEXT.md "never truncate" decision), adds Pygments for evidence highlighting, and adds post-processing dedup in runner.py (RPT-04).

Output: A Jinja2-based report generator with an external HTML template, Pygments evidence highlighting, full evidence bodies, and deduplication in the runner.
</objective>

<execution_context>
@/home/abdulr7man/.claude/get-shit-done/workflows/execute-plan.md
@/home/abdulr7man/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-evidence-report-quality/01-CONTEXT.md
@.planning/phases/01-evidence-report-quality/01-RESEARCH.md
@api_pentest/core/models.py
@api_pentest/reporting/report_generator.py
@api_pentest/runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite report generator with Jinja2 autoescape, Pygments evidence, and extract HTML template</name>
  <files>
    api_pentest/reporting/report_generator.py
    api_pentest/reporting/templates/report.html
    api_pentest/core/models.py
    requirements.txt
  </files>
  <action>
  **Step 1: Add Pygments to requirements.txt**
  Add `pygments>=2.19.0` to requirements.txt (after the existing entries).

  **Step 2: Remove Evidence body truncation in models.py**
  In `api_pentest/core/models.py`, line 116, change:
  ```python
  "body": self.response_body[:2000] if self.response_body else "",
  ```
  to:
  ```python
  "body": self.response_body if self.response_body else "",
  ```

  **Step 3: Create Jinja2 HTML template file**
  Create directory `api_pentest/reporting/templates/` and file `report.html`.
  The template should:
  - Use the same dark-theme CSS from the current HTML_TEMPLATE constant (preserve the existing visual design)
  - Use Jinja2 template syntax (`{{ }}`, `{% %}`) instead of `{{placeholders}}`
  - Include a `{% for finding in findings %}` loop for findings
  - Include a `{% for result in results %}` loop for the test results table
  - Evidence blocks rendered via a custom Jinja2 filter or passed as pre-rendered Markup
  - Findings sorted by severity (the Python code sorts before passing to template)
  - Evidence displayed inside `<details><summary>View Evidence</summary>` blocks
  - Add Pygments inline styles to evidence blocks (no external CSS needed since using `noclasses=True`)
  - Include evidence timing (response_time_ms) in each evidence block

  **Step 4: Rewrite report_generator.py**
  Replace the entire ReportGenerator class implementation:

  1. Remove the `HTML_TEMPLATE` constant string at the top of the file.
  2. Remove the `_escape()` function at the bottom of the file.
  3. Add imports: `from jinja2 import Environment, FileSystemLoader, select_autoescape` and `from pygments import highlight` and `from pygments.lexers import HttpLexer, JsonLexer, TextLexer` and `from pygments.formatters import HtmlFormatter` and `from markupsafe import Markup`.
  4. Create a module-level Jinja2 Environment:
     ```python
     _template_dir = Path(__file__).parent / "templates"
     _env = Environment(
         loader=FileSystemLoader(str(_template_dir)),
         autoescape=select_autoescape(["html"]),
         trim_blocks=True,
         lstrip_blocks=True,
     )
     ```
  5. Create a Pygments formatter:
     ```python
     _formatter = HtmlFormatter(noclasses=True, style="monokai", nowrap=False)
     ```
  6. Add a helper function `_format_evidence_html(evidence: Evidence) -> Markup` that:
     - Builds request text: `"{method} {url}\n{headers}\n\n{body}"`
     - Builds response text: `"HTTP/1.1 {status}\n{headers}\n\n{body}"`
     - Highlights both with `highlight(text, HttpLexer(), _formatter)`
     - Wraps in Markup() so Jinja2 does not double-escape
     - Includes response_time_ms in the output
  7. Rewrite `generate_html()`:
     - Sort findings by severity (Critical first, Info last)
     - For each finding with evidence, call `_format_evidence_html()` and attach the result
     - Get the template: `template = _env.get_template("report.html")`
     - Render: `html = template.render(timestamp=..., summary=..., findings=..., results=...)`
     - Write to file
     - The template receives findings as a list of dicts (from `finding.to_dict()`) with an additional `evidence_html` key containing the Markup
  8. Keep `generate_json()` unchanged except it now benefits from the untruncated Evidence.to_dict().
  9. Keep `_build_summary()` unchanged.

  **Important: Avoid these anti-patterns (from RESEARCH.md):**
  - Do NOT use `|safe` filter on untrusted data in the template. Only Pygments output (wrapped in Markup) is safe.
  - Do NOT escape evidence in the model layer. Evidence stays raw; escaping happens at render time via Jinja2 autoescape.
  - Do NOT use f-strings to build HTML in Python. Let Jinja2 handle all HTML generation.
  </action>
  <verify>
  1. `python -c "from api_pentest.reporting.report_generator import ReportGenerator; print('Import OK')"` -- must succeed
  2. `python -c "from pathlib import Path; assert (Path('api_pentest/reporting/templates/report.html')).exists(); print('Template exists')"` -- must succeed
  3. `grep -c "str.replace" api_pentest/reporting/report_generator.py` -- must return 0 (no manual replacements)
  4. `grep -c "_escape" api_pentest/reporting/report_generator.py` -- must return 0 (function removed)
  5. `grep -c "autoescape" api_pentest/reporting/report_generator.py` -- must return >= 1
  6. `grep -c "[:2000]" api_pentest/core/models.py` -- must return 0 (truncation removed)
  7. `grep "pygments" requirements.txt` -- must show pygments entry
  8. Smoke test: Create a Finding with evidence containing `<script>alert(1)</script>` in response_body, generate HTML report, verify the script tag is escaped in the output file (appears as `&lt;script&gt;` not `<script>`).
  </verify>
  <done>
  Report generator uses Jinja2 with autoescape. Evidence blocks are Pygments-highlighted. HTML template is in a separate file. _escape() function is removed. Evidence bodies are not truncated. XSS payloads in response bodies are safely escaped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add post-processing finding deduplication in runner.py</name>
  <files>
    api_pentest/runner.py
  </files>
  <action>
  Add a `deduplicate_findings()` function and call it before report generation.

  1. Add function at module level (before the PentestRunner class) or as a static method:
     ```python
     def deduplicate_findings(findings: list[Finding]) -> list[Finding]:
         """Remove duplicate findings. Keep first occurrence, silently drop rest.
         Uniqueness key: (title, endpoint). Endpoint includes HTTP method.
         Different parameters produce different titles, so are naturally distinct.
         """
         seen: set[tuple[str, str]] = set()
         unique: list[Finding] = []
         for finding in findings:
             key = (finding.title, finding.endpoint)
             if key not in seen:
                 seen.add(key)
                 unique.append(finding)
         return unique
     ```

  2. In `PentestRunner.run()`, after the scenario execution loop completes and before `self._print_summary(total_elapsed)` is called (around line 197-200), add:
     ```python
     # Deduplicate findings (RPT-04)
     self.all_findings = deduplicate_findings(self.all_findings)
     ```

  This ensures dedup runs as post-processing after all scenarios complete, before both the terminal summary and report generation. The dedup function is simple and follows the CONTEXT.md decision: key is (title, endpoint), keep first occurrence, silently drop duplicates.
  </action>
  <verify>
  1. `python -c "from api_pentest.runner import deduplicate_findings, PentestRunner; print('Import OK')"` -- must succeed
  2. `grep -n "deduplicate_findings" api_pentest/runner.py` -- must show function definition and call site
  3. Unit verification:
     ```python
     python -c "
     from api_pentest.runner import deduplicate_findings
     from api_pentest.core.models import Finding, Severity
     f1 = Finding(severity=Severity.HIGH, title='XSS', description='d', endpoint='GET /api')
     f2 = Finding(severity=Severity.HIGH, title='XSS', description='d2', endpoint='GET /api')
     f3 = Finding(severity=Severity.HIGH, title='XSS', description='d3', endpoint='POST /api')
     result = deduplicate_findings([f1, f2, f3])
     assert len(result) == 2, f'Expected 2, got {len(result)}'
     assert result[0] is f1
     assert result[1] is f3
     print('Dedup OK')
     "
     ```
  </verify>
  <done>
  deduplicate_findings() function exists in runner.py. It is called on self.all_findings before _print_summary() and _generate_reports(). Duplicate findings (same title + endpoint) are collapsed to first occurrence.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Full import chain works: `python -c "from api_pentest.runner import PentestRunner; from api_pentest.reporting.report_generator import ReportGenerator; print('All OK')"`
2. XSS prevention: Generate an HTML report with a Finding containing `<script>alert(1)</script>` in response_body. Open the HTML file and confirm the script tag is escaped, not executed.
3. No truncation: `grep -rn "[:2000]\|[:500]" api_pentest/core/models.py api_pentest/reporting/report_generator.py` -- returns empty
4. Dedup works: Test with duplicate findings, confirm only unique ones remain
5. Template exists: `ls api_pentest/reporting/templates/report.html` succeeds
6. No manual escaping: `grep -n "_escape" api_pentest/reporting/report_generator.py` returns empty
7. Pygments in requirements: `grep "pygments" requirements.txt` returns the entry
</verification>

<success_criteria>
- RPT-03 addressed: HTML report uses Jinja2 autoescape, XSS payloads in evidence are safely escaped
- RPT-04 addressed: Findings are deduplicated by (title, endpoint) before report generation
- Evidence bodies are never truncated (CONTEXT.md decision honored)
- Evidence blocks in HTML report have Pygments syntax highlighting
- Report generator no longer uses manual str.replace() or _escape() function
- Jinja2 HTML template extracted to separate file
</success_criteria>

<output>
After completion, create `.planning/phases/01-evidence-report-quality/01-02-SUMMARY.md`
</output>
