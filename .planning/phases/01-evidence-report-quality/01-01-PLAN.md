---
phase: 01-evidence-report-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api_pentest/scenarios/s01_token_reuse.py
  - api_pentest/scenarios/s02_rate_limiting.py
  - api_pentest/scenarios/s05_auth_hijacking.py
  - api_pentest/scenarios/s11_security_misconfig.py
autonomous: true

must_haves:
  truths:
    - "Every log_finding() call in S01, S02, S05, S11 includes an endpoint= parameter with format 'METHOD /path'"
    - "Every log_finding() call in S01, S02, S05, S11 includes an evidence= parameter with the Evidence object from the triggering request"
    - "Aggregate findings that previously reported 'accepted by N/M endpoints' are split into one finding per vulnerable endpoint"
    - "Findings are only generated for endpoints that actually showed the vulnerability, not for tested-but-clean endpoints"
  artifacts:
    - path: "api_pentest/scenarios/s01_token_reuse.py"
      provides: "Per-endpoint findings for cross_endpoint_replay, old_token_after_refresh, cross_user_token_swap"
      contains: "endpoint=f\"{ep.method} {ep.url}\""
    - path: "api_pentest/scenarios/s02_rate_limiting.py"
      provides: "Per-endpoint findings for burst_requests, response_time_degradation, rate_limit_headers"
      contains: "endpoint=f\"{ep.method} {ep.url}\""
    - path: "api_pentest/scenarios/s05_auth_hijacking.py"
      provides: "Per-endpoint findings for expired_jwt, tampered_signature, alg_none, stripped_signature"
      contains: "endpoint=f\"{ep.method} {ep.url}\""
    - path: "api_pentest/scenarios/s11_security_misconfig.py"
      provides: "Per-endpoint findings for security_headers_check"
      contains: "endpoint=f\"{ep.method} {ep.url}\""
  key_links:
    - from: "api_pentest/scenarios/s01_token_reuse.py"
      to: "BaseScenario.log_finding()"
      via: "self.log_finding() calls with endpoint= and evidence= kwargs"
      pattern: "self\\.log_finding\\(.*endpoint=.*evidence="
    - from: "api_pentest/scenarios/s11_security_misconfig.py"
      to: "BaseScenario.log_finding()"
      via: "Per-endpoint log_finding replacing 'Multiple endpoints' string"
      pattern: "self\\.log_finding\\(.*endpoint=f\""
---

<objective>
Decompose aggregate findings in scenarios S01, S02, S05, and S11 into per-endpoint findings with evidence.

Purpose: Currently 11 aggregate findings across these 4 scenarios report grouped results ("accepted by N/M endpoints") with no endpoint field and no evidence. This plan splits each into one finding per vulnerable endpoint, with the triggering HTTP request/response attached as evidence. This directly addresses requirements FIX-05 (missing endpoint), FIX-06 (missing evidence), RPT-01 (endpoint in all findings), and RPT-02 (evidence for aggregate findings).

Output: Four refactored scenario files where every log_finding() call includes endpoint= and evidence= parameters. No aggregate findings remain.
</objective>

<execution_context>
@/home/abdulr7man/.claude/get-shit-done/workflows/execute-plan.md
@/home/abdulr7man/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-evidence-report-quality/01-CONTEXT.md
@.planning/phases/01-evidence-report-quality/01-RESEARCH.md
@api_pentest/scenarios/base_scenario.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Decompose S01 and S02 aggregate findings into per-endpoint findings</name>
  <files>
    api_pentest/scenarios/s01_token_reuse.py
    api_pentest/scenarios/s02_rate_limiting.py
  </files>
  <action>
  **S01 (s01_token_reuse.py) -- 3 methods to refactor:**

  1. `_test_cross_endpoint_replay()` (line ~34-79):
     - Currently: Loops all endpoints, counts accepted, emits single finding at end with no endpoint= and no evidence=.
     - Fix: Move `log_finding()` inside the loop. For each endpoint where `is_success_status(evidence.response_status)` is True, emit a finding with:
       - `endpoint=f"{ep.method} {ep.url}"`
       - `evidence=evidence` (the Evidence object from `make_request`)
       - Keep the same title "Token accepted across most endpoints"
       - Update description to be per-endpoint (remove "N out of M" phrasing, say something like "A single token was accepted at this endpoint. Token may have excessive scope.")
     - Keep the ratio > 0.8 guard -- only emit findings if the overall ratio exceeds 0.8. The loop emits per-endpoint findings only if the threshold is met.
     - Pattern: First loop counts accepted/tested. If ratio > 0.8, second loop re-tests and emits per-finding. OR: collect results in first loop, emit findings after threshold check.
     - Preferred approach: Collect (endpoint, evidence) pairs in first loop for accepted endpoints. After loop, if ratio > 0.8, iterate pairs and emit per-endpoint findings.

  2. `_test_old_token_after_refresh()` (line ~81-132):
     - Currently: Loops endpoints[:10], counts old_accepted, emits single finding with evidence= only from last iteration.
     - Fix: Collect (endpoint, evidence) pairs for accepted endpoints. After loop, if old_accepted > 0, emit per-endpoint findings with endpoint= and evidence= for each.
     - Title remains "Old tokens not revoked after refresh".
     - Description per-endpoint: "After token refresh, the previous token was still accepted at this endpoint."

  3. `_test_cross_user_token_swap()` (line ~134-183):
     - Currently: Loops endpoints[:10], counts cross_accepted, emits single finding with no endpoint= and no evidence=.
     - Fix: Collect (endpoint, evidence) pairs. After loop, emit per-endpoint findings.
     - Title remains "Cross-user token swap accepted".
     - Description per-endpoint: "User A's token was accepted at this endpoint that User B also has access to. This may indicate insufficient user-level authorization."

  **S02 (s02_rate_limiting.py) -- 3 methods to refactor:**

  1. `_test_burst_requests()` (line ~43-106):
     - Currently: Loops 5 endpoints, emits single aggregate finding at end if no rate limiting found on any endpoint.
     - Fix: Instead of one aggregate finding, emit per-endpoint findings inside the loop for each endpoint where rate_limited == 0 (no 429 detected). Move `log_finding()` into the per-endpoint block (inside the `if rate_limited > 0` / `else` branching). In the else branch (no rate limiting), add:
       - `self.log_finding(severity=Severity.MEDIUM, title="No rate limiting detected", endpoint=f"{ep.method} {ep.url}", evidence=evidence, ...)`
     - Remove the aggregate `if not any_rate_limited:` finding block at the end.
     - The `any_rate_limited` variable and aggregate finding at line 94-106 should be removed entirely.

  2. `_test_response_time_degradation()` (line ~108-157):
     - Currently: Tests first endpoint, emits finding with no endpoint= and no evidence=.
     - Fix: Add `endpoint=f"{ep.method} {ep.url}"` and `evidence=ev` (use the last Evidence from the load test, or the baseline evidence) to the log_finding() call.
     - Use `evidence=baseline` (the baseline Evidence object) since it represents the endpoint being tested.

  3. `_test_rate_limit_headers()` (line ~159-197):
     - Currently: Tests first endpoint, emits finding with no endpoint= and no evidence=.
     - Fix: Add `endpoint=f"{ep.method} {ep.url}"` and `evidence=evidence` to the log_finding() call.
  </action>
  <verify>
  Run: `grep -n "log_finding" api_pentest/scenarios/s01_token_reuse.py api_pentest/scenarios/s02_rate_limiting.py`
  Every log_finding() call must have both `endpoint=` and `evidence=` parameters.
  Run: `grep -c "endpoint=\"Multiple" api_pentest/scenarios/s01_token_reuse.py api_pentest/scenarios/s02_rate_limiting.py` -- must return 0 for both.
  Run: `python -c "import api_pentest.scenarios.s01_token_reuse; import api_pentest.scenarios.s02_rate_limiting; print('OK')"` -- must print OK (no import errors).
  </verify>
  <done>
  All log_finding() calls in S01 and S02 include endpoint= and evidence= parameters. No aggregate findings remain. Files import without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Decompose S05 and S11 aggregate findings into per-endpoint findings</name>
  <files>
    api_pentest/scenarios/s05_auth_hijacking.py
    api_pentest/scenarios/s11_security_misconfig.py
  </files>
  <action>
  **S05 (s05_auth_hijacking.py) -- 4 methods to refactor:**

  All four methods follow the same pattern: loop endpoints[:10], count accepted, emit single aggregate finding at end. Apply the same fix to each:

  1. `_test_expired_jwt()` (line ~46-86):
     - Collect (endpoint, evidence) pairs where `is_success_status()` is True.
     - After loop, if accepted > 0, emit per-endpoint findings with endpoint= and evidence=.
     - Title: "Expired JWT tokens accepted"
     - Per-endpoint description: "A JWT with exp set to 24 hours in the past was accepted at this endpoint."

  2. `_test_tampered_signature()` (line ~88-128):
     - Same pattern. Title: "JWT signature verification bypassed"
     - Per-endpoint description: "A JWT with corrupted signature bytes was accepted at this endpoint. Signature verification may be disabled."

  3. `_test_alg_none()` (line ~130-173):
     - Same pattern. Title: "JWT alg:none attack successful"
     - Per-endpoint description: "A JWT with algorithm set to 'none' and empty signature was accepted at this endpoint."

  4. `_test_stripped_signature()` (line ~175-215):
     - Same pattern. Title: "JWT with stripped signature accepted"
     - Per-endpoint description: "A JWT with the signature completely removed was accepted at this endpoint."

  Note: `_test_tampered_claims()` already emits per-endpoint findings with endpoint= and evidence=. No changes needed.

  **S11 (s11_security_misconfig.py) -- 1 method to refactor:**

  `_test_security_headers()` (line ~97-145):
  - Currently: Loops endpoints[:10], collects missing headers per header name, emits one finding per header with `endpoint="Multiple endpoints"` and no evidence=.
  - Fix: Change the data structure to track per-endpoint, per-header results. For each endpoint where a header is missing, emit a finding with:
    - `endpoint=f"{ep.method} {ep.url}"`
    - `evidence=evidence` (the Evidence object from make_request for that endpoint)
    - Title: f"Missing security header: {header}" (unchanged)
    - Description: f"{desc}. Header not present in response." (per-endpoint, no "Missing on N endpoints" phrasing)
  - Approach: Restructure the loop to be endpoint-first, then header-check. For each endpoint, make the request once, check all required+recommended headers, and emit per-endpoint per-missing-header findings.
  - This will produce more findings (e.g., if 10 endpoints are each missing 6 headers, that is 60 findings). This is correct -- dedup in Plan 02 will collapse identical (title, endpoint) pairs.

  Note: Other S11 methods (_test_version_disclosure, _test_trace_method, _test_default_credentials, _test_cookie_flags, _test_error_verbosity, _test_cors_deep) already emit per-endpoint findings with endpoint= and evidence=. No changes needed.
  </action>
  <verify>
  Run: `grep -n "log_finding" api_pentest/scenarios/s05_auth_hijacking.py api_pentest/scenarios/s11_security_misconfig.py`
  Every log_finding() call must have both `endpoint=` and `evidence=` parameters.
  Run: `grep -c "endpoint=\"Multiple" api_pentest/scenarios/s05_auth_hijacking.py api_pentest/scenarios/s11_security_misconfig.py` -- must return 0 for both.
  Run: `python -c "import api_pentest.scenarios.s05_auth_hijacking; import api_pentest.scenarios.s11_security_misconfig; print('OK')"` -- must print OK.
  </verify>
  <done>
  All log_finding() calls in S05 and S11 include endpoint= and evidence= parameters. No "Multiple endpoints" string remains. No aggregate findings. Files import without errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -rn "log_finding" api_pentest/scenarios/s01_token_reuse.py api_pentest/scenarios/s02_rate_limiting.py api_pentest/scenarios/s05_auth_hijacking.py api_pentest/scenarios/s11_security_misconfig.py` -- every call includes endpoint= and evidence=
2. `grep -rn "endpoint=\"Multiple\|endpoint=\"\"" api_pentest/scenarios/s01_token_reuse.py api_pentest/scenarios/s02_rate_limiting.py api_pentest/scenarios/s05_auth_hijacking.py api_pentest/scenarios/s11_security_misconfig.py` -- returns empty (no aggregate/empty endpoints)
3. `grep -rn "log_finding" api_pentest/scenarios/s01_token_reuse.py api_pentest/scenarios/s02_rate_limiting.py api_pentest/scenarios/s05_auth_hijacking.py api_pentest/scenarios/s11_security_misconfig.py | grep -v "endpoint=" | grep -v "^--$"` -- returns empty (no log_finding without endpoint)
4. All four files import cleanly: `python -c "import api_pentest.scenarios.s01_token_reuse; import api_pentest.scenarios.s02_rate_limiting; import api_pentest.scenarios.s05_auth_hijacking; import api_pentest.scenarios.s11_security_misconfig; print('All imports OK')"`
</verification>

<success_criteria>
- Requirements FIX-05, FIX-06, RPT-01, RPT-02 addressed: every finding in S01, S02, S05, S11 has endpoint and evidence
- No aggregate findings remain (no "accepted by N/M endpoints" as single finding)
- No "Multiple endpoints" string in any endpoint= parameter
- All scenario files import without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-evidence-report-quality/01-01-SUMMARY.md`
</output>
