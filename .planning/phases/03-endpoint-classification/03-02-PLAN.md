---
phase: 03-endpoint-classification
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - api_pentest/scenarios/base_scenario.py
  - api_pentest/scenarios/s07_access_controls.py
  - api_pentest/scenarios/s08_api_responses.py
autonomous: true

must_haves:
  truths:
    - "S07 no_auth_access skips endpoints classified as public -- no finding logged for /, /books/v1, /createdb"
    - "S07 malformed_token_access skips endpoints classified as public -- no finding logged for GET /"
    - "S08 sensitive_field_exposure filters out expected auth fields (auth_token, access_token, etc.) for auth-endpoint classified endpoints"
    - "Skipped tests are logged at DEBUG level with classification reason"
    - "All other S07 and S08 tests continue to run unchanged for protected endpoints"
  artifacts:
    - path: "api_pentest/scenarios/base_scenario.py"
      provides: "is_public_endpoint() and is_auth_endpoint() helper methods"
      contains: "is_public_endpoint"
    - path: "api_pentest/scenarios/s07_access_controls.py"
      provides: "Classification-aware no_auth_access and malformed_token_access tests"
      contains: "is_public_endpoint"
    - path: "api_pentest/scenarios/s08_api_responses.py"
      provides: "Classification-aware sensitive_field_exposure test"
      contains: "is_auth_endpoint"
  key_links:
    - from: "api_pentest/scenarios/base_scenario.py"
      to: "api_pentest/core/models.py"
      via: "imports EndpointClassification to check endpoint.classification"
      pattern: "EndpointClassification"
    - from: "api_pentest/scenarios/s07_access_controls.py"
      to: "api_pentest/scenarios/base_scenario.py"
      via: "calls self.is_public_endpoint(ep) before logging auth findings"
      pattern: "self\\.is_public_endpoint"
    - from: "api_pentest/scenarios/s08_api_responses.py"
      to: "api_pentest/scenarios/base_scenario.py"
      via: "calls self.is_auth_endpoint(ep) to filter expected auth fields"
      pattern: "self\\.is_auth_endpoint"
---

<objective>
Integrate endpoint classification into S07 and S08 scenarios to eliminate the 5 targeted false positives (3 from no_auth_access, 1 from malformed_token_access, 1 from sensitive_field_exposure).

Purpose: This is where the FP elimination actually happens -- the classifier from Plan 01 provides data, this plan makes scenarios act on it.
Output: Updated S07 and S08 with classification-aware test logic, BaseScenario with helper methods.
</objective>

<execution_context>
@/home/abdulr7man/.claude/get-shit-done/workflows/execute-plan.md
@/home/abdulr7man/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-endpoint-classification/03-RESEARCH.md
@.planning/phases/03-endpoint-classification/03-01-SUMMARY.md
@api_pentest/scenarios/base_scenario.py
@api_pentest/scenarios/s07_access_controls.py
@api_pentest/scenarios/s08_api_responses.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add classification helper methods to BaseScenario</name>
  <files>api_pentest/scenarios/base_scenario.py</files>
  <action>
Add import of `EndpointClassification` from `api_pentest.core.models` (add to the existing import statement that already imports Endpoint, Evidence, etc.).

Add two helper methods to BaseScenario:

```python
def is_public_endpoint(self, endpoint: Endpoint) -> bool:
    """Check if endpoint is classified as public (no auth required)."""
    return endpoint.classification == EndpointClassification.PUBLIC

def is_auth_endpoint(self, endpoint: Endpoint) -> bool:
    """Check if endpoint is classified as an auth endpoint (returns credentials by design)."""
    return endpoint.classification == EndpointClassification.AUTH_ENDPOINT
```

Place these after `is_auth_failure()` and before the end of the class. These are simple attribute checks -- no complex logic.

Do NOT modify any existing methods. Do NOT change the `setup()` signature. The classification data is already on the Endpoint objects passed via `endpoints` parameter.
  </action>
  <verify>
`python -c "
from api_pentest.core.models import Endpoint, EndpointClassification
from api_pentest.scenarios.base_scenario import BaseScenario
# Can't instantiate ABC directly, just verify the methods exist
print(hasattr(BaseScenario, 'is_public_endpoint'))
print(hasattr(BaseScenario, 'is_auth_endpoint'))
"` prints True, True.
  </verify>
  <done>BaseScenario has is_public_endpoint() and is_auth_endpoint() helper methods that check endpoint.classification. All scenarios inherit these methods.</done>
</task>

<task type="auto">
  <name>Task 2: Update S07 to skip auth tests for public endpoints</name>
  <files>api_pentest/scenarios/s07_access_controls.py</files>
  <action>
Two methods need classification checks. The other three tests (undocumented_methods, cors_misconfiguration, debug_endpoint_probing) are NOT about authentication and should NOT be skipped per RESEARCH.md open questions.

**1. `_test_no_auth_access()`** (lines 57-102):
Replace the existing `is_public = "public-no-auth" in ep.tags` check with the classifier-based check. At the top of the for loop, BEFORE `self.make_request()`:

```python
for ep in self.endpoints:
    # Skip public endpoints -- no auth expected
    if self.is_public_endpoint(ep):
        logger.debug(
            "Skipping no-auth test for %s %s: %s",
            ep.method, ep.url, ep.classification_reason,
        )
        continue

    evidence = self.make_request(ep, token=None)
    tested += 1
    # ... rest of the logic stays the same, but REMOVE the old
    # is_public = "public-no-auth" in ep.tags check and the
    # if not is_public: guard. The finding should always be logged
    # now because public endpoints are already skipped above.
```

The key change: move the `make_request` AFTER the public check so we don't even send requests to public endpoints. Remove the old `is_public = "public-no-auth" in ep.tags` and `if not is_public:` block entirely -- the skip-and-continue handles it.

**2. `_test_malformed_token_access()`** (lines 104-150):
Add a public endpoint filter when building the test endpoint list. Change:
```python
test_eps = self.endpoints[:5]
```
to:
```python
test_eps = [ep for ep in self.endpoints if not self.is_public_endpoint(ep)][:5]
```

Also add a debug log for any skipped endpoints (optional but good for audit trail). This ensures public endpoints like GET / are excluded from the malformed token test.

Do NOT touch `_test_undocumented_methods`, `_test_cors_misconfiguration`, or `_test_debug_endpoints`.
  </action>
  <verify>
Read the updated s07_access_controls.py and confirm:
1. `_test_no_auth_access` calls `self.is_public_endpoint(ep)` with continue
2. No reference to `"public-no-auth" in ep.tags` remains
3. `_test_malformed_token_access` filters public endpoints from test_eps
4. `_test_undocumented_methods`, `_test_cors_misconfiguration`, `_test_debug_endpoints` are unchanged
  </verify>
  <done>S07 skips auth-related tests (no_auth_access, malformed_token_access) for public endpoints. Three non-auth tests unchanged. The 3 FPs from no_auth_access on /, /books/v1, /createdb and 1 FP from malformed_token_access on / are eliminated.</done>
</task>

<task type="auto">
  <name>Task 3: Update S08 to filter expected auth fields for auth-endpoints</name>
  <files>api_pentest/scenarios/s08_api_responses.py</files>
  <action>
Only `_test_sensitive_field_exposure()` needs changes. The other tests (verbose_error_detection, response_header_info_leak, cross_role_field_comparison) are not affected by endpoint classification.

**In `_test_sensitive_field_exposure()`** (lines 78-139):

Add a class-level constant for expected auth response fields:
```python
EXPECTED_AUTH_FIELDS = {
    "auth_token", "access_token", "refresh_token",
    "token", "session_token", "session_id",
}
```

After `field_matches = self.SENSITIVE_FIELD_PATTERNS.findall(body)` and before logging the finding, add a filter:

```python
field_matches = self.SENSITIVE_FIELD_PATTERNS.findall(body)
if field_matches:
    # Filter out expected auth fields for auth-endpoints
    if self.is_auth_endpoint(ep):
        field_matches = [
            f for f in field_matches
            if f.lower() not in self.EXPECTED_AUTH_FIELDS
        ]
        if not field_matches:
            logger.debug(
                "Skipping sensitive field finding for auth-endpoint %s %s: "
                "fields are expected auth response (%s)",
                ep.method, ep.url, ep.classification_reason,
            )

    if field_matches:
        unique_fields = list(set(field_matches))
        # ... existing finding logic (add_result + log_finding) ...
```

The structure is: find matches -> filter if auth-endpoint -> only log if unfiltered matches remain.

Move the `unique_fields = list(set(field_matches))` and the `sensitive_found = True` + `add_result` + `log_finding` block inside the inner `if field_matches:` check.

Do NOT modify `_test_verbose_error_detection`, `_test_response_header_info_leak`, or `_test_cross_role_field_comparison`.

Do NOT modify the SENSITIVE_DATA_PATTERNS check (it looks for SSN/credit card patterns which are never expected from auth endpoints).
  </action>
  <verify>
Read the updated s08_api_responses.py and confirm:
1. EXPECTED_AUTH_FIELDS constant exists with auth_token, access_token, etc.
2. `_test_sensitive_field_exposure` calls `self.is_auth_endpoint(ep)` to filter field_matches
3. The auth_token field from /users/v1/login will be filtered out (it's in EXPECTED_AUTH_FIELDS)
4. Non-auth sensitive fields (password, ssn, etc.) are NOT filtered for any endpoint
5. Other test methods are unchanged
  </verify>
  <done>S08 filters expected auth response fields (auth_token, access_token, etc.) from sensitive field findings when endpoint is classified as auth-endpoint. The 1 FP from /users/v1/login returning auth_token is eliminated. Non-auth sensitive fields still flagged for all endpoints.</done>
</task>

</tasks>

<verification>
1. Read all three modified files and confirm classification integration
2. `python -c "from api_pentest.scenarios.base_scenario import BaseScenario; print(hasattr(BaseScenario, 'is_public_endpoint'), hasattr(BaseScenario, 'is_auth_endpoint'))"` prints True True
3. `python -c "from api_pentest.scenarios.s07_access_controls import S07AccessControls; print('OK')"` imports clean
4. `python -c "from api_pentest.scenarios.s08_api_responses import S08APIResponses; print('OK')"` imports clean
5. Grep for `"public-no-auth" in ep.tags` in s07 -- should NOT be found (replaced by classifier)
6. Grep for `is_public_endpoint` in s07 -- should be found
7. Grep for `is_auth_endpoint` in s08 -- should be found
8. Grep for `EXPECTED_AUTH_FIELDS` in s08 -- should be found
</verification>

<success_criteria>
- 3 FPs eliminated: S07 no_auth_access on GET /, GET /books/v1, GET /createdb (public endpoints skipped)
- 1 FP eliminated: S07 malformed_token_access on GET / (public endpoint excluded from test set)
- 1 FP eliminated: S08 sensitive_field_exposure on POST /users/v1/login (auth_token filtered for auth-endpoint)
- Total: 5 FPs eliminated, matching Phase 3 success criteria
- Non-auth tests (undocumented_methods, CORS, debug_endpoints, verbose_errors, header_info_leak, cross_role) unchanged
- Skipped tests logged at DEBUG level with classification reason
</success_criteria>

<output>
After completion, create `.planning/phases/03-endpoint-classification/03-02-SUMMARY.md`
</output>
