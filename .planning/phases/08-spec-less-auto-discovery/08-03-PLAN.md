---
phase: 08-spec-less-auto-discovery
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - run_pentest.py
  - api_pentest/runner.py
autonomous: true

must_haves:
  truths:
    - "Running with --url (no --input) triggers automatic spec discovery"
    - "If spec is found at common path, it is parsed and used for testing (same as --input flow)"
    - "If no spec found, EndpointFuzzer discovers endpoints for testing"
    - "Discovered endpoints flow through existing classification, prerequisite detection, and testing pipeline"
    - "Progress feedback shows discovery stages (spec discovery, endpoint fuzzing)"
  artifacts:
    - path: "run_pentest.py"
      provides: "--url CLI argument as alternative to --input"
      contains: ["--url", "parser.add_argument"]
      min_lines: 175
    - path: "api_pentest/runner.py"
      provides: "URL-only mode handling with two-stage discovery"
      contains: ["_discover_from_url", "SpecDiscoverer", "EndpointFuzzer"]
      min_lines: 480
  key_links:
    - from: "run_pentest.py"
      to: "api_pentest/runner.py"
      via: "config url passed to PentestRunner"
      pattern: "config\\[.*url.*\\]"
    - from: "api_pentest/runner.py"
      to: "api_pentest/core/spec_discoverer.py"
      via: "SpecDiscoverer import"
      pattern: "from api_pentest\\.core\\.spec_discoverer import SpecDiscoverer"
    - from: "api_pentest/runner.py"
      to: "api_pentest/core/endpoint_fuzzer.py"
      via: "EndpointFuzzer import"
      pattern: "from api_pentest\\.core\\.endpoint_fuzzer import EndpointFuzzer"
---

<objective>
Update CLI to support --url mode and wire discovery into runner with progress feedback.

Purpose: Enable the `--url` flag as an alternative to `--input`, triggering the two-stage discovery pipeline (spec discovery first, then endpoint fuzzing as fallback). This completes the DISC-07, DISC-08, DISC-09 requirements.

Output: Updated run_pentest.py with --url argument and updated runner.py with _discover_from_url() method that orchestrates the discovery pipeline.
</objective>

<execution_context>
@/home/abdulr7man/.claude/get-shit-done/workflows/execute-plan.md
@/home/abdulr7man/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-spec-less-auto-discovery/08-RESEARCH.md
@.planning/phases/08-spec-less-auto-discovery/08-01-SUMMARY.md
@.planning/phases/08-spec-less-auto-discovery/08-02-SUMMARY.md
@run_pentest.py
@api_pentest/runner.py
@api_pentest/core/input_detector.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --url CLI argument to run_pentest.py</name>
  <files>run_pentest.py</files>
  <action>
Update `run_pentest.py` to support --url as alternative to --input:

1. **Add --url argument** (after --input):
   ```python
   parser.add_argument(
       "--url", "-u",
       help="Base URL for auto-discovery (alternative to --input). "
            "Discovers API spec at common paths (/openapi.json, /swagger.json, etc.), "
            "falls back to endpoint fuzzing if no spec found.",
   )
   ```

2. **Update --input to not be required** - change `required=True` to just having the argument optional

3. **Add mutual exclusion validation** (after parsing arguments, before validating input file):
   ```python
   # Validate --input XOR --url required
   if not args.input and not args.url:
       parser.error("Either --input or --url is required")
   if args.input and args.url:
       parser.error("Cannot use both --input and --url")
   ```

4. **Skip input file existence check when using --url**:
   - Wrap the existing `if not Path(args.input).exists()` check in `if args.input:`

5. **Pass url to config** in cli_overrides:
   ```python
   cli_overrides = {
       "input": args.input,
       "url": args.url,  # Add this
       "env": args.env,
       "base_url": args.base_url,
       "output_dir": args.output_dir,
   }
   ```

6. **Update load_config** to handle url:
   ```python
   if cli_overrides.get("url"):
       config["discovery_url"] = cli_overrides["url"]
   ```

7. **Update usage examples** in epilog to include --url example:
   ```
   %(prog)s --url http://api.example.com --config pentest.yaml
   ```
  </action>
  <verify>
```bash
python run_pentest.py --help | grep -A2 -- "--url"
```
  </verify>
  <done>--url CLI argument added as alternative to --input with proper validation</done>
</task>

<task type="auto">
  <name>Task 2: Wire discovery into PentestRunner</name>
  <files>api_pentest/runner.py</files>
  <action>
Update `api_pentest/runner.py` to handle URL-only mode:

1. **Add imports** at top:
   ```python
   from api_pentest.core.spec_discoverer import SpecDiscoverer, SpecType
   from api_pentest.core.endpoint_fuzzer import EndpointFuzzer
   from api_pentest.core.api_discovery import RequestBudget
   import tempfile
   ```

2. **Update parse_input() method** to detect URL-only mode:
   Replace the current implementation with:
   ```python
   def parse_input(self) -> list[Endpoint]:
       """Parse the input file (Postman or OpenAPI) or discover from URL."""
       input_file = self.config.get("input_file", "")
       discovery_url = self.config.get("discovery_url", "")
       env_file = self.config.get("environment_file")
       base_url = self.config.get("base_url")

       # URL-only mode: trigger auto-discovery
       if not input_file and discovery_url:
           return self._discover_from_url(discovery_url)

       # Existing file-based parsing
       detector = InputDetector(
           file_path=input_file,
           environment_path=env_file,
           base_url_override=base_url,
       )
       self.endpoints = detector.parse()
       # ... rest of existing code ...
   ```

3. **Add _discover_from_url() method**:
   ```python
   def _discover_from_url(self, url: str) -> list[Endpoint]:
       """Auto-discover API spec or endpoints from URL only.

       Two-stage discovery:
       1. Try spec discovery at common paths (cheap, ~15 requests)
       2. Fall back to endpoint fuzzing if no spec found (more expensive)
       """
       self.init_http()

       # Create shared budget for discovery
       budget = RequestBudget(max_requests=100)

       print(f"{Fore.CYAN}Starting API discovery from {url}...{Style.RESET_ALL}")

       # Stage 1: Try to find spec at common paths
       print(f"{Fore.WHITE}[Stage 1] Searching for API specification...{Style.RESET_ALL}")
       discoverer = SpecDiscoverer(
           base_url=url,
           http_client=self.http,
           budget=budget,
       )
       spec_content, spec_type = discoverer.discover()

       if spec_content and spec_type:
           print(f"{Fore.GREEN}  Found {spec_type.value} spec!{Style.RESET_ALL}")
           return self._parse_discovered_spec(spec_content, spec_type, url)

       print(f"{Fore.YELLOW}  No spec found at common paths{Style.RESET_ALL}")

       # Stage 2: Fall back to endpoint fuzzing
       print(f"{Fore.WHITE}[Stage 2] Fuzzing for API endpoints...{Style.RESET_ALL}")
       fuzzer = EndpointFuzzer(
           base_url=url,
           http_client=self.http,
           budget=budget,
       )
       self.endpoints = fuzzer.fuzz()

       print(f"{Fore.GREEN}  Discovered {len(self.endpoints)} endpoints{Style.RESET_ALL}")

       return self.endpoints
   ```

4. **Add _parse_discovered_spec() helper method**:
   ```python
   def _parse_discovered_spec(
       self,
       spec_content: str,
       spec_type: SpecType,
       base_url: str
   ) -> list[Endpoint]:
       """Parse discovered spec content using existing parsers.

       Saves spec to temp file and uses InputDetector for parsing,
       ensuring discovered specs follow the same path as --input specs.
       """
       # Determine file extension based on spec type
       suffix = ".json"  # Default to JSON

       # Save to temp file
       with tempfile.NamedTemporaryFile(
           mode="w",
           suffix=suffix,
           delete=False,
           encoding="utf-8",
       ) as f:
           f.write(spec_content)
           temp_path = f.name

       try:
           detector = InputDetector(
               file_path=temp_path,
               base_url_override=base_url,
           )
           self.endpoints = detector.parse()

           fmt = detector.format
           print(f"{Fore.CYAN}Spec format: {fmt.value if fmt else 'unknown'}{Style.RESET_ALL}")
           print(f"{Fore.CYAN}Endpoints discovered: {len(self.endpoints)}{Style.RESET_ALL}")

           for w in detector.warnings:
               print(f"{Fore.YELLOW}  Warning: {w}{Style.RESET_ALL}")

           return self.endpoints
       finally:
           # Clean up temp file
           import os
           try:
               os.unlink(temp_path)
           except OSError:
               pass
   ```

5. **Update _get_raw_spec()** to handle URL-only mode:
   At the start of the method, add check:
   ```python
   # URL-only mode: no raw spec available (discovered spec is transient)
   if not self.config.get("input_file") and self.config.get("discovery_url"):
       # If we discovered a spec, it was saved to _discovered_spec_content
       if hasattr(self, "_discovered_spec_content"):
           import json
           try:
               self._raw_spec_cache = json.loads(self._discovered_spec_content)
               return self._raw_spec_cache
           except json.JSONDecodeError:
               pass
       self._raw_spec_cache = None
       return None
   ```

6. **Store discovered spec** in _parse_discovered_spec():
   After parsing, store for later use:
   ```python
   self._discovered_spec_content = spec_content
   ```
  </action>
  <verify>
```bash
python -c "from api_pentest.runner import PentestRunner; r = PentestRunner({'discovery_url': 'http://example.com'}); print('URL mode check OK')"
```
  </verify>
  <done>runner.py handles URL-only mode with two-stage discovery pipeline and progress feedback</done>
</task>

</tasks>

<verification>
1. Run help to verify --url flag appears: `python run_pentest.py --help`
2. Test mutual exclusion: `python run_pentest.py --input test.json --url http://example.com` (should error)
3. Test required argument: `python run_pentest.py` (should error requiring --input or --url)
4. Verify URL mode starts discovery: test with a real API URL if available
5. Run existing tests to ensure no regressions: `python -m pytest tests/ -v --tb=short` (if tests exist)
</verification>

<success_criteria>
- `--url` argument exists as alternative to `--input` (DISC-09)
- `--url` and `--input` are mutually exclusive
- One of `--url` or `--input` is required
- URL-only mode triggers SpecDiscoverer first (DISC-07)
- If spec found, it's parsed using existing InputDetector flow
- If no spec found, EndpointFuzzer discovers endpoints (DISC-08)
- Discovered endpoints flow through classification, prerequisites, and testing unchanged
- Progress feedback shows [Stage 1] and [Stage 2] during discovery
- Graceful fallback to built-in wordlist when Kiterunner not installed (DISC-10)
</success_criteria>

<output>
After completion, create `.planning/phases/08-spec-less-auto-discovery/08-03-SUMMARY.md`
</output>
