---
phase: 08-spec-less-auto-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api_pentest/core/spec_discoverer.py
  - api_pentest/core/__init__.py
autonomous: true

must_haves:
  truths:
    - "SpecDiscoverer probes common spec paths and returns spec content when found"
    - "SpecDiscoverer detects spec type (OpenAPI, Swagger, GraphQL) from response content"
    - "SpecDiscoverer respects RequestBudget to avoid request storms"
  artifacts:
    - path: "api_pentest/core/spec_discoverer.py"
      provides: "SpecDiscoverer class for auto-discovery at common paths"
      exports: ["SpecDiscoverer", "SpecType"]
      min_lines: 100
  key_links:
    - from: "api_pentest/core/spec_discoverer.py"
      to: "api_pentest/core/api_discovery.py"
      via: "import RequestBudget"
      pattern: "from api_pentest\\.core\\.api_discovery import.*RequestBudget"
    - from: "api_pentest/core/spec_discoverer.py"
      to: "api_pentest/core/http_client.py"
      via: "PentestHttpClient for requests"
      pattern: "http_client\\.request"
---

<objective>
Build SpecDiscoverer to auto-discover API specifications at common paths.

Purpose: Enable the toolkit to find API specs automatically when given only a URL, trying standard spec paths like /openapi.json, /swagger.json, /api-docs before falling back to endpoint fuzzing.

Output: New spec_discoverer.py module with SpecDiscoverer class that probes common paths and returns spec content + type if found.
</objective>

<execution_context>
@/home/abdulr7man/.claude/get-shit-done/workflows/execute-plan.md
@/home/abdulr7man/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-spec-less-auto-discovery/08-RESEARCH.md
@api_pentest/core/api_discovery.py (RequestBudget class)
@api_pentest/core/http_client.py (PentestHttpClient)
@api_pentest/core/models.py (Evidence dataclass)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpecDiscoverer with common path probing</name>
  <files>api_pentest/core/spec_discoverer.py</files>
  <action>
Create new module `api_pentest/core/spec_discoverer.py` with:

1. **SpecType enum** with values:
   - `OPENAPI_30` - OpenAPI 3.x spec
   - `SWAGGER_20` - Swagger 2.0 spec
   - `GRAPHQL` - GraphQL introspection response

2. **SpecDiscoverer class** with:
   - Constructor: `__init__(self, base_url: str, http_client, budget: RequestBudget)`
   - Store base_url (strip trailing slash), http_client, budget

3. **SPEC_PATHS class constant** - ordered list of common spec paths to try:
   ```python
   SPEC_PATHS = [
       # OpenAPI/Swagger JSON
       "/openapi.json",
       "/swagger.json",
       "/api-docs",
       "/api/openapi.json",
       "/api/swagger.json",
       "/v1/swagger.json",
       "/v2/swagger.json",
       "/v3/swagger.json",
       "/swagger/v1/swagger.json",
       "/docs.json",
       "/api-docs.json",
       # OpenAPI/Swagger YAML
       "/openapi.yaml",
       "/swagger.yaml",
       # GraphQL
       "/graphql",
       "/api/graphql",
       "/gql",
       "/query",
   ]
   ```

4. **discover() method** returning `tuple[str | None, SpecType | None]`:
   - Iterate through SPEC_PATHS
   - For each path, check budget.can_request() - break loop if exhausted
   - Make GET request to base_url + path via http_client.request()
   - Call budget.record() after each request
   - If response status is 200:
     - Call _detect_spec_type(response_body) to identify spec type
     - If spec type detected, return (response_body, spec_type)
   - If no spec found after all paths, return (None, None)
   - Log info for each path tried (found/not found)

5. **_detect_spec_type(body: str) method** returning `SpecType | None`:
   - Try to parse body as JSON (handle JSONDecodeError gracefully)
   - Check for OpenAPI 3.x: `data.get("openapi", "").startswith("3.")`
   - Check for Swagger 2.0: `data.get("swagger") == "2.0"`
   - Check for GraphQL introspection: `"__schema" in data` or `"data" in data and "__schema" in data.get("data", {})`
   - Return appropriate SpecType or None if no match

6. **_try_graphql_introspection(url: str) method** returning `tuple[str | None, SpecType | None]`:
   - POST to GraphQL endpoint with introspection query:
     ```json
     {"query": "{ __schema { types { name } } }"}
     ```
   - Check if response contains `__schema`
   - Return (body, GRAPHQL) if introspection succeeds
   - Use budget for this request too

Modify discover() to call _try_graphql_introspection() for paths ending in /graphql, /gql, /query instead of plain GET.

Add module docstring and logging via `logger = logging.getLogger(__name__)`.
  </action>
  <verify>
```bash
python -c "from api_pentest.core.spec_discoverer import SpecDiscoverer, SpecType; print('Import OK')"
```
  </verify>
  <done>SpecDiscoverer class exists with discover() method that probes common paths and returns spec content + type</done>
</task>

<task type="auto">
  <name>Task 2: Export SpecDiscoverer from core module</name>
  <files>api_pentest/core/__init__.py</files>
  <action>
Update `api_pentest/core/__init__.py` to export the new classes:

Add imports:
```python
from api_pentest.core.spec_discoverer import SpecDiscoverer, SpecType
```

Add to `__all__` list (create if not exists):
```python
__all__ = [
    # ... existing exports ...
    "SpecDiscoverer",
    "SpecType",
]
```
  </action>
  <verify>
```bash
python -c "from api_pentest.core import SpecDiscoverer, SpecType; print('Export OK')"
```
  </verify>
  <done>SpecDiscoverer and SpecType are importable from api_pentest.core</done>
</task>

</tasks>

<verification>
1. Run import test: `python -c "from api_pentest.core.spec_discoverer import SpecDiscoverer, SpecType"`
2. Verify SpecType enum has all three values: `python -c "from api_pentest.core.spec_discoverer import SpecType; print([t.value for t in SpecType])"`
3. Verify SPEC_PATHS contains at least 15 common paths
4. Run existing tests to ensure no regressions: `python -m pytest tests/ -v --tb=short` (if tests exist)
</verification>

<success_criteria>
- SpecDiscoverer class created with discover() method
- SPEC_PATHS constant contains common OpenAPI/Swagger/GraphQL paths
- _detect_spec_type() correctly identifies spec format from JSON content
- GraphQL endpoints probed with introspection query (POST) not plain GET
- RequestBudget respected - no more requests than allowed
- Module importable from api_pentest.core
</success_criteria>

<output>
After completion, create `.planning/phases/08-spec-less-auto-discovery/08-01-SUMMARY.md`
</output>
